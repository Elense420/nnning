<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=yes">
  <title>AI å°è¯´å®¶ Â· çº¯å‰ç«¯ç‰ˆ</title>
  <!-- å¼•å…¥ JSZip (ç”¨äºå¤šç« èŠ‚æ‰“åŒ…ä¸‹è½½) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    /* åŸæœ‰æ ·å¼ä¿ç•™ï¼Œå¹¶å¢åŠ ç§»åŠ¨ç«¯ä¼˜åŒ– */
    :root { --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif; --radius: 0.8rem; --shadow: 0 4px 12px rgba(0,0,0,0.05); --shadow-lg: 0 10px 30px rgba(0,0,0,0.07); --transition: all 0.2s ease-in-out; }
    body { font-family: var(--font-sans); transition: background-color 0.3s, color 0.3s; margin: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    .light-mode { --bg-main: #f4f7f5; --bg-panel: #ffffff; --text-primary: #1a2c21; --text-secondary: #5a6d61; --text-muted: #8a9d91; --border-color: #e5eae7; }
    .dark-mode { --bg-main: #121815; --bg-panel: #1a231e; --text-primary: #e0e8e3; --text-secondary: #a0b0a8; --text-muted: #6a7c72; --border-color: #2a3831; }
    [data-theme="green"] { --accent: #2e8b57; --accent-light: #d9eee4; --danger: #d9534f; }
    [data-theme="pink"] { --accent: #e91e63; --accent-light: #fce4ec; --danger: #f06292; }
    [data-theme="blue"] { --accent: #2196f3; --accent-light: #e3f2fd; --danger: #ef5350; }
    [data-theme="yellow"] { --accent: #ffc107; --accent-light: #fff8e1; --danger: #ff7043; }
    [data-theme="purple"] { --accent: #9c27b0; --accent-light: #f3e5f5; --danger: #ab47bc; }
    [data-theme="white"] { --accent: #607d8b; --accent-light: #eceff1; --danger: #ef5350; }
    .dark-mode [data-theme="green"] { --accent-light: rgba(46, 139, 87, 0.2); }
    .dark-mode [data-theme="pink"] { --accent-light: rgba(233, 30, 99, 0.2); }
    .dark-mode [data-theme="blue"] { --accent-light: rgba(33, 150, 243, 0.2); }
    .dark-mode [data-theme="yellow"] { --accent-light: rgba(255, 193, 7, 0.2); }
    .dark-mode [data-theme="purple"] { --accent-light: rgba(156, 39, 176, 0.2); }
    .dark-mode [data-theme="white"] { --accent-light: rgba(96, 125, 139, 0.2); }
    body { background-color: var(--bg-main); color: var(--text-primary); line-height: 1.6; }
    .container { padding: 24px; max-width: 1200px; margin: 0 auto; }
    .panel { background-color: var(--bg-panel); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 24px; margin-bottom: 24px; box-shadow: var(--shadow); transition: var(--transition); }
    h2 { margin-top: 0; font-size: 1.5rem; color: var(--text-primary); border-bottom: 2px solid var(--accent-light); padding-bottom: 12px; }
    h3 { color: var(--text-secondary); font-size: 1.1rem; }
    hr { border: none; border-top: 1px solid var(--border-color); margin: 24px 0; }
    pre { white-space: pre-wrap; word-wrap: break-word; background-color: var(--bg-main); padding: 16px; border-radius: calc(var(--radius) - 4px); color: var(--text-secondary); }
    .hidden { display: none !important; }
    .topbar { position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; background: var(--bg-panel-translucent, rgba(255, 255, 255, 0.5)); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); }
    .dark-mode { --bg-panel-translucent: rgba(26, 35, 30, 0.5); }
    .brand { font-size: 1.2rem; font-weight: 600; color: var(--accent); }
    .tab { padding: 8px 16px; border: none; background: transparent; color: var(--text-secondary); font-size: 1rem; border-radius: 8px; cursor: pointer; transition: var(--transition); }
    .tab:hover { background: var(--accent-light); color: var(--accent); }
    .tab.active { color: var(--accent); font-weight: 600; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .field { margin-bottom: 16px; }
    .field label { display: block; font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }
    input, select, textarea { width: 100%; box-sizing: border-box; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-main); color: var(--text-primary); font-size: 1rem; transition: var(--transition); }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    textarea { resize: vertical; min-height: 100px; }
    .checkbox-label { display: flex; align-items: center; gap: 8px; font-weight: 500; }
    .optional-container { margin-top: 12px; padding-left: 16px; border-left: 3px solid var(--accent-light); }
    .slider-range { width: 100%; -webkit-appearance: none; appearance: none; height: 8px; background: var(--border-color); border-radius: 4px; outline: none; }
    .slider-range::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
    .slider-range::-moz-range-thumb { width: 20px; height: 20px; background: var(--accent); border-radius: 50%; cursor: pointer; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 20px; }
    button { padding: 10px 20px; border-radius: 8px; border: 1px solid transparent; font-size: 1rem; font-weight: 500; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    button svg { width: 1.2em; height: 1.2em; fill: currentColor; }
    button.primary { background: var(--accent); color: white; }
    button.primary:hover { opacity: 0.85; }
    button.secondary { background: var(--accent-light); color: var(--accent); }
    button.secondary:hover { background: var(--accent); color: white; }
    button.danger { background: var(--danger); color: white; border-color: var(--danger);}
    button.danger:hover { background: var(--danger); opacity: 0.85; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .status, .hint { margin-top: 16px; font-size: 0.9rem; color: var(--text-muted); }
    .novel-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .novel-card { background: var(--bg-panel); border-radius: var(--radius); padding: 20px; border: 1px solid var(--border-color); transition: var(--transition); cursor: pointer; }
    .novel-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .novel-card h3 { margin: 0 0 8px 0; }
    .novel-card-meta { font-size: 0.85rem; color: var(--text-muted); }
    .chapter-nav { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
    #chapterIndicator { font-weight: 600; color: var(--text-secondary); }
    #chapterOutput { background: var(--bg-main); padding: 20px; border-radius: calc(var(--radius) - 4px); margin-bottom: 24px; white-space: pre-wrap; font-size: 1.05rem; line-height: 1.7; }
    #genMeta { color: var(--text-muted); font-size: 0.8rem; padding: 10px; background: var(--bg-main); border-radius: 8px; white-space: pre-wrap; margin-bottom: 24px; }
    .options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    #rewriteContainer { padding: 20px; border: 1px dashed var(--accent); border-radius: var(--radius); margin-top: 24px; background-color: var(--accent-light); }
    .dark-mode #rewriteContainer { background-color: transparent; }
    dialog { border: 1px solid var(--border-color); border-radius: var(--radius); box-shadow: var(--shadow-lg); padding: 24px; width: 90%; max-width: 800px; background: var(--bg-panel); color: var(--text-primary); }
    dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(3px); }
    .dialog-close-btn { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-muted); line-height: 1; padding: 0; }
    .dialog-content { max-height: 70vh; overflow-y: auto; padding-right: 10px; }
    .dialog-section { margin-bottom: 24px; }
    .chapter-list { list-style: none; padding: 0; }
    .chapter-list li { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 8px; transition: var(--transition); }
    .chapter-list li:hover { background-color: var(--accent-light); }
    .chapter-list li label { flex-grow: 1; cursor: pointer; }
    .chapter-list li input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 1.1em; height: 1.1em; border: 2px solid var(--border-color); border-radius: 4px; background-color: var(--bg-panel); margin: 0; cursor: pointer; position: relative; flex-shrink: 0; transition: background-color 0.2s, border-color 0.2s; }
    .chapter-list li input[type="checkbox"]:checked { background-color: var(--accent); border-color: var(--accent); }
    .chapter-list li input[type="checkbox"]:checked::after { content: 'âœ”'; display: block; color: white; font-size: 0.8em; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .theme-switcher { display: flex; gap: 10px; }
    .theme-btn { width: 30px; height: 30px; border-radius: 50%; padding: 0; border: 2px solid transparent; }
    .theme-btn.active { border-color: var(--accent); transform: scale(1.1); }
    .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; }
    .switch .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
    input:checked + .slider { background-color: var(--accent); }
    input:focus + .slider { box-shadow: 0 0 1px var(--accent); }
    input:checked + .slider:before { transform: translateX(26px); }
    .slider.round { border-radius: 34px; }
    .slider.round:before { border-radius: 50%; }
    .settings-review { margin-bottom: 24px; border: 1px solid var(--border-color); border-radius: var(--radius); background-color: var(--bg-panel); box-shadow: var(--shadow); overflow: hidden; }
    .review-header { padding: 12px 16px; background-color: var(--accent-light); display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-color); }
    .review-header h3 { margin: 0; font-size: 1.1rem; color: var(--accent); font-weight: 600; }
    .review-content { padding: 16px; max-height: 250px; overflow-y: auto; font-size: 0.9rem; line-height: 1.7; color: var(--text-secondary); transition: all 0.3s ease-out; }
    .review-content.hidden { max-height: 0; padding-top: 0; padding-bottom: 0; visibility: hidden; opacity: 0; }
    .review-content p { margin: 8px 0; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
    .review-content p:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .review-content strong { color: var(--text-primary); font-weight: 600; }
    button.small { padding: 4px 12px; font-size: 0.85rem; font-weight: normal; }
    .dialog-footer-actions { margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color); justify-content: flex-end; }

    /* ----- ç§»åŠ¨ç«¯ä¼˜åŒ– ----- */
    @media (max-width: 768px) {
      .container { padding: 12px; }
      .topbar { padding: 8px 12px; flex-wrap: wrap; gap: 8px; }
      .top-actions { display: flex; flex-wrap: wrap; justify-content: center; width: 100%; }
      .tab { padding: 6px 12px; font-size: 0.9rem; }
      .brand { font-size: 1.1rem; }
      .grid2 { grid-template-columns: 1fr; gap: 12px; }
      .panel { padding: 16px; }
      h2 { font-size: 1.3rem; }
      .row { gap: 8px; }
      button { padding: 10px 16px; font-size: 0.95rem; min-height: 44px; } /* å¢åŠ è§¦æ‘¸åŒºåŸŸ */
      .options { grid-template-columns: 1fr; }
      .writer-header { flex-direction: column; align-items: flex-start; }
      .writer-controls { display: flex; flex-wrap: wrap; width: 100%; gap: 8px; }
      .writer-controls select { flex: 1; min-width: 120px; }
      #chapterOutput { font-size: 1rem; padding: 12px; }
      .chapter-nav { gap: 12px; }
      .chapter-nav button { padding: 8px 12px; }
      .settings-review { margin-bottom: 16px; }
      .review-content { max-height: 200px; }
      dialog { width: 95%; padding: 16px; }
      .dialog-footer-actions { justify-content: center; }
      .chapter-list li { padding: 12px; } /* å¢å¤§è¡Œé«˜ä¾¿äºç‚¹å‡» */
      .chapter-list li input[type="checkbox"] { width: 1.3em; height: 1.3em; }
    }

    /* æ›´å°å±å¹•ï¼ˆå°äº480pxï¼‰è¿›ä¸€æ­¥è°ƒæ•´ */
    @media (max-width: 480px) {
      .top-actions { gap: 4px; }
      .tab { padding: 5px 8px; font-size: 0.85rem; }
      .container { padding: 8px; }
      .panel { padding: 12px; }
      .field label { font-size: 0.85rem; }
      input, select, textarea { padding: 10px 12px; font-size: 0.95rem; }
      button { width: 100%; } /* å°å±å¹•ä¸ŠæŒ‰é’®å æ»¡å®½åº¦ï¼Œæ–¹ä¾¿ç‚¹å‡» */
      .row button { width: auto; } /* è¡Œå†…æŒ‰é’®ä¸å¼ºåˆ¶å æ»¡ */
      .dialog-footer-actions button { width: auto; }
      .options button { width: auto; }
    }
  </style>
</head>
<body data-theme="green" class="light-mode">
  <header class="topbar">
    <div class="brand">AI å°è¯´å®¶ Â· çº¯å‰ç«¯ç‰ˆ</div>
    <div class="top-actions">
      <button id="btnTabNovels" class="tab">æˆ‘çš„ä¹¦åº“</button>
      <button id="btnTabSetup" class="tab active">å†™ä½œè®¾å®š</button>
      <button id="btnTabWriter" class="tab">å°è¯´æ‰©å†™</button>
      <button id="btnTabConfig" class="tab">APIé…ç½®åŠåŸºç¡€è®¾ç½®</button>
    </div>
  </header>

  <main class="container">
    <!-- æˆ‘çš„ä¹¦åº“é¡µ -->
    <section id="viewNovels" class="view hidden">
      <div class="panel">
        <h2>æˆ‘çš„ä¹¦åº“</h2>
        <div id="novelList" class="novel-list"></div>
        <div class="hint">æ‰€æœ‰å°è¯´æ•°æ®å‡ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ã€‚</div>
      </div>
    </section>

    <!-- APIé…ç½®åŠåŸºç¡€è®¾ç½®é¡µ -->
    <section id="viewConfig" class="view hidden">
      <div class="panel">
        <h2>API é…ç½®</h2>
        <div class="grid2">
          <div class="field"><label for="cfgName">é…ç½®åç§°</label><input id="cfgName" placeholder="ä¾‹å¦‚ï¼šä¸»çº¿è·¯"/></div>
          <div class="field"><label for="cfgProvider">Provider ç±»å‹</label><select id="cfgProvider"><option value="openai-compatible">OpenAI å…¼å®¹</option></select></div>
          <div class="field"><label for="cfgBaseUrl">Base URL</label><input id="cfgBaseUrl" placeholder="https://api.openai.com/v1"/></div>
          <div class="field"><label for="cfgApiKey">API Key</label><input id="cfgApiKey" type="password"/></div>
        </div>
        <div class="row"><button id="btnAddCfg">ä¿å­˜é…ç½®</button><button id="btnTestCfg" class="secondary">æµ‹è¯•è¿æ¥</button></div>
        <div id="cfgStatus" class="status"></div>
      </div>
      <div class="panel">
        <h3>å·²ä¿å­˜çš„é…ç½®</h3>
        <div class="row"><select id="cfgSelect"></select><button id="btnLoadModels">åŠ è½½æ¨¡å‹åˆ—è¡¨</button><button id="btnDeleteCfg" class="danger">åˆ é™¤å½“å‰é…ç½®</button></div>
        <div class="row"><label for="modelSelect">å¯ç”¨æ¨¡å‹ï¼š</label><select id="modelSelect"></select></div>
      </div>
      <div class="panel">
        <h2>ç•Œé¢è®¾ç½®</h2>
        <div class="field">
            <label>ä¸»é¢˜é¢œè‰²</label>
            <div id="themeSwitcher" class="theme-switcher">
                <button data-theme="green" class="theme-btn active" style="background:#2e8b57;" title="æ·¡å¢¨ç»¿"></button>
                <button data-theme="pink" class="theme-btn" style="background:#e91e63;" title="æ·¡ç²‰è‰²"></button>
                <button data-theme="blue" class="theme-btn" style="background:#2196f3;" title="æ·¡è“è‰²"></button>
                <button data-theme="yellow" class="theme-btn" style="background:#ffc107;" title="æ·¡é»„è‰²"></button>
                <button data-theme="purple" class="theme-btn" style="background:#9c27b0;" title="æ·¡ç´«è‰²"></button>
                <button data-theme="white" class="theme-btn" style="background:#607d8b;" title="çº¯ç™½"></button>
            </div>
        </div>
        <div class="field">
            <label>æ˜¾ç¤ºæ¨¡å¼</label>
            <label class="switch">
                <input type="checkbox" id="modeToggle">
                <span class="slider round"></span>
            </label>
        </div>
      </div>
    </section>

    <!-- å†™ä½œè®¾å®šé¡µ -->
    <section id="viewSetup" class="view">
        <div class="panel"><h2>åˆ›å»ºæ–°å°è¯´</h2><div class="field"><label for="novelTitle">å°è¯´ä¹¦å (å¿…å¡«)</label><input id="novelTitle" placeholder="ç»™ä½ çš„æ•…äº‹èµ·ä¸ªåå­—"/></div></div>
        <div class="panel">
            <h2>å°è¯´æ ¸å¿ƒè®¾å®š</h2>
            <div class="grid2">
                <div class="field"><label for="novelGenre">å°è¯´ç±»å‹/é¢˜æ (å¿…å¡«)</label><input id="novelGenre" placeholder="éƒ½å¸‚å¼‚èƒ½ã€æ‚¬ç–‘ã€ç§‘å¹»"/></div>
                <div class="field"><label for="novelStyle">ç›®æ ‡è¯»è€…ä¸é£æ ¼ (å¿…å¡«)</label><input id="novelStyle" placeholder="è½»å¿«å¹½é»˜ã€ä¸¥è‚ƒå²è¯—ã€çˆ½æ–‡"/></div>
                <div class="field"><label for="chapterWords">æ¯ç« å­—æ•° (å¿…å¡«)</label><input id="chapterWords" type="number" min="200" step="100" value="2000"/></div>
                <div class="field"><label for="novelPOV">äººç§°</label><select id="novelPOV"><option value="ç¬¬ä¸‰äººç§°">ç¬¬ä¸‰äººç§°</option><option value="ç¬¬ä¸€äººç§°">ç¬¬ä¸€äººç§°</option></select></div>
                <div class="field"><label for="novelTense">æ—¶æ€</label><select id="novelTense"><option value="è¿‡å»æ—¶">è¿‡å»æ—¶</option><option value="ç°åœ¨æ—¶">ç°åœ¨æ—¶</option></select></div>
                <div class="field"><label for="temperature">æ¸©åº¦ (0-2)</label><input id="temperature" type="number" min="0" max="2" step="0.1" value="0.8"/></div>
            </div>
            <div class="field"><label for="contextMemory">ä¸Šä¸‹æ–‡è®°å¿†ç« èŠ‚æ•°: <span id="contextMemoryValue">3</span></label><input type="range" id="contextMemory" min="0" max="20" value="3" class="slider-range"></div>
            <hr/>
            <div class="field"><label for="novelCharacters">ä¸»è¦è§’è‰²è¡¨ (å¯é€‰)</label><textarea id="novelCharacters" rows="4" placeholder="ä¾‹å¦‚ï¼š- æ—æ˜¼ï¼šç”·ä¸»ï¼Œå†·é™ç†æ€§..."></textarea></div>
            <div class="field"><label for="novelWorld">ä¸–ç•Œè§‚è®¾å®š (å¯é€‰)</label><textarea id="novelWorld" rows="4" placeholder="ä¸–ç•Œè§„åˆ™ã€ç§‘æŠ€/é­”æ³•ä½“ç³»..."></textarea></div>
        </div>
        <div class="panel">
            <h2>AI è§’è‰²ä¸å¤§çº²</h2>
            <div class="field"><label for="aiPersona">AI è®¾å®š (è‡ªå®šä¹‰ç¨‹åºè¡Œä¸º)</label><textarea id="aiPersona" rows="5" placeholder="è¿™æ˜¯æœ€é¡¶å±‚çš„æŒ‡ä»¤..."></textarea><div class="row"><select id="personaHistory"></select><button id="btnLoadPersona" class="secondary">åŠ è½½</button><button id="btnSavePersona" class="secondary">ä¿å­˜</button></div></div>
            <div class="field"><label for="novelOutline">å°è¯´å¤§çº² (å¿…å¡«)</label><textarea id="novelOutline" rows="8" placeholder="è¯·å†™ä¸‹ä¸»çº¿..."></textarea></div>
            <div class="row"><button id="btnImproveOutline" class="secondary">AI å®Œå–„å¤§çº²</button><select id="outlineHistory"></select><button id="btnRestoreOutline" class="secondary">å›æ»š</button></div>
        </div>
        <div class="panel"><h2>å¼€å§‹åˆ›ä½œ</h2><div class="row"><button id="btnStart" class="primary">å¼€å§‹æ‰©å†™ç¬¬ä¸€ç« </button></div><div id="setupMeta" class="status"></div></div>
    </section>

    <!-- å°è¯´æ‰©å†™é¡µ -->
    <section id="viewWriter" class="view hidden">
      <div class="panel">
        <div id="settingsReviewPanel" class="settings-review">
          <div class="review-header">
            <h3>ğŸ“– æœ¬ä¹¦è®¾å®šå›é¡¾ (ä¸å¯ç¼–è¾‘)</h3>
            <button id="btnCollapseReview" class="secondary small">æŠ˜å </button>
          </div>
          <div id="reviewContent" class="review-content"></div>
        </div>
        <div class="writer-header"><h2 id="writerChapterTitle"></h2><div class="writer-controls"><label for="writerApiSelect">çº¿è·¯</label><select id="writerApiSelect"></select><label for="writerModelSelect">æ¨¡å‹</label><select id="writerModelSelect"></select></div></div>
        <div class="chapter-nav"><button id="btnPrevChapter" class="secondary">ä¸Šä¸€ç« </button><span id="chapterIndicator"></span><button id="btnNextChapter" class="secondary">ä¸‹ä¸€ç« </button></div>
        <div id="genMeta" class="meta"></div>
        <div id="chapterOutput"></div>
        <hr />
        
        <div id="rewriteContainer">
            <h3>é‡å†™å½“å‰ç« èŠ‚</h3>
            <div class="field">
                <label for="rewritePlot">è¯·è¾“å…¥æœ¬ç« æ–°çš„å‰§æƒ…èµ°å‘ï¼š</label>
                <textarea id="rewritePlot" rows="3" placeholder="é‡å†™åï¼Œå½“å‰ç‰ˆæœ¬åŠä¹‹åç« èŠ‚å°†è¢«å­˜æ¡£ã€‚"></textarea>
            </div>
            <div class="row"><button id="btnRewriteChapter" class="danger">ç¡®è®¤é‡å†™</button></div>
            <div id="rewriteMeta" class="status"></div>
        </div>

        <div id="continueContainer" class="hidden">
            <hr />
            <h3>åç»­ç« èŠ‚åˆ›ä½œ</h3>
            <div class="field">
                <label for="nextPlot">ä¸‹ä¸€ç« å‰§æƒ…èµ°å‘ (å¯é€‰)</label>
                <textarea id="nextPlot" rows="3" placeholder="å¡«å†™åç‚¹å‡»â€œç»§ç»­æ‰©å†™â€ã€‚"></textarea>
            </div>
            <h4>AI ç»™å‡ºçš„åç»­æ–¹å‘</h4>
            <div id="nextOptions" class="options"></div>
            <div class="row">
                <button id="btnNext" class="primary">ç»§ç»­æ‰©å†™ä¸‹ä¸€ç« </button>
                <button id="btnBackToSetup" class="secondary">è¿”å›ä¿®æ”¹è®¾å®š</button>
            </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ä¹¦ç±è¯¦æƒ… Dialog -->
  <dialog id="bookDetailDialog">
    <h2 id="bookDetailTitle"></h2><button id="closeBookDetail" class="dialog-close-btn">&times;</button>
    <div class="dialog-content">
        <div class="dialog-section"><h3>å°è¯´å¤§çº²</h3><pre id="bookDetailOutline"></pre></div>
        <div class="dialog-section"><h3>ç« èŠ‚ç›®å½• (<span id="activeChapterCount"></span>)</h3><ul id="activeChaptersList" class="chapter-list"></ul></div>
        <div class="dialog-section">
            <h3>å†å²å­˜æ¡£ (<span id="archivedChapterCount"></span>)</h3>
            <p class="hint">å½“é‡å†™æŸä¸ªç« èŠ‚æ—¶ï¼Œè¯¥ç« èŠ‚çš„æ—§ç‰ˆæœ¬ä¼šä¿å­˜åœ¨è¿™é‡Œã€‚</p>
            <ul id="archivedChaptersList" class="chapter-list"></ul>
            <div class="row"><button id="btnDownloadArchives" class="secondary">ä¸‹è½½é€‰ä¸­å­˜æ¡£ (TXT)</button></div>
        </div>
        <div class="dialog-footer-actions row">
            <button class="primary with-icon" id="btnBookDetailContinue"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>ç»§ç»­å†™ä½œ</button>
            <button class="secondary with-icon" id="btnBookDetailDownload"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zm7-18c-3.87 0-7 3.13-7 7 0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>ä¸‹è½½æœ‰æ•ˆç« èŠ‚</button>
            <button class="danger with-icon" id="btnBookDetailDelete"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>åˆ é™¤æœ¬ä¹¦</button>
        </div>
    </div>
  </dialog>

  <!-- é˜…è¯» Dialog -->
  <dialog id="readChapterDialog"><h2 id="readChapterTitle"></h2><button id="closeReadChapter" class="dialog-close-btn">&times;</button><div class="dialog-content"><pre id="readChapterContent"></pre></div></dialog>

  <!-- ä¸‹è½½ Dialog -->
  <dialog id="downloadDialog">
    <h3>ä¸‹è½½å°è¯´</h3>
    <div class="field">
        <label for="downloadFormat">æ ¼å¼ï¼š</label>
        <select id="downloadFormat">
            <option value="txt-single">åˆå¹¶ TXT</option>
            <option value="zip-txt">åˆ†ç«  ZIP (TXT)</option>
            <option value="html-single">åˆå¹¶ HTML</option>
            <option value="zip-html">åˆ†ç«  ZIP (HTML)</option>
        </select>
    </div>
    <div class="row"><button id="btnConfirmDownload" class="primary">ç¡®è®¤</button><button id="btnCancelDownload" class="secondary">å–æ¶ˆ</button></div>
  </dialog>

  <script>
    (function() {
      // åŸ app.js ä¿®æ”¹ç‰ˆï¼Œç§»é™¤å¯¹åç«¯çš„ä¾èµ–ï¼Œæ”¹ä¸ºç›´æ¥è°ƒç”¨ API
      const el = (id) => document.getElementById(id);
      const lsGet = (k, d = null) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
      const lsSet = (k, v) => localStorage.setItem(k, JSON.stringify(v));

      // --- å…¨å±€çŠ¶æ€ ---
      let books = lsGet("books", []);
      let currentBook = lsGet("currentBook", null);
      let currentChapterIndex = currentBook ? currentBook.chapters.length - 1 : -1;
      let configs = lsGet("configs", []);
      let activeCfgId = lsGet("activeCfgId", null);
      let modelList = lsGet("modelList", []);
      let personaHistory = lsGet("personaHistory", []);
      let outlineHistory = lsGet("outlineHistory", []);
      let uiSettings = lsGet("uiSettings", { theme: "green", mode: "light" });
      let bookToDownloadId = null;

      // --- è§†å›¾ç®¡ç† ---
      const TABS = { 
          novels: { btn: el("btnTabNovels"), view: el("viewNovels") }, 
          setup: { btn: el("btnTabSetup"), view: el("viewSetup") }, 
          writer: { btn: el("btnTabWriter"), view: el("viewWriter") }, 
          config: { btn: el("btnTabConfig"), view: el("viewConfig") }
      };
      function setView(viewName) {
          Object.values(TABS).forEach(({ btn, view }) => {
              const isActive = view === TABS[viewName].view;
              btn.classList.toggle("active", isActive);
              view.classList.toggle("hidden", !isActive);
          });
          if (viewName === 'novels') renderBookList();
          if (viewName === 'writer' && currentBook) renderSettingsReview();
      }

      // --- UI è®¾ç½® ---
      function applyUISettings() {
          document.body.className = uiSettings.mode === 'dark' ? 'dark-mode' : 'light-mode';
          document.body.dataset.theme = uiSettings.theme;
          if (el('modeToggle')) el('modeToggle').checked = uiSettings.mode === 'dark';
          document.querySelectorAll('.theme-btn').forEach(btn => { btn.classList.toggle('active', btn.dataset.theme === uiSettings.theme); });
      }
      function saveUISettings() { lsSet("uiSettings", uiSettings); }

      if (el('modeToggle')) el('modeToggle').onchange = (e) => { uiSettings.mode = e.target.checked ? 'dark' : 'light'; saveUISettings(); applyUISettings(); };
      if (el('themeSwitcher')) el('themeSwitcher').addEventListener('click', (e) => { if (e.target.matches('.theme-btn')) { uiSettings.theme = e.target.dataset.theme; saveUISettings(); applyUISettings(); } });
      Object.keys(TABS).forEach(key => TABS[key].btn.onclick = () => setView(key));
      el("btnBackToSetup").onclick = () => { if(currentBook) loadSettingsFromBook(currentBook); setView("setup"); };

      // --- è®¾å®šå›é¡¾é¢æ¿ ---
      function renderSettingsReview() {
          if (!currentBook) return;
          const s = currentBook.settings;
          const reviewContentEl = el('reviewContent');
          reviewContentEl.innerHTML = `
              <p><strong>ä¹¦åï¼š</strong>${currentBook.title}</p>
              <p><strong>é¢˜æï¼š</strong>${s.genre} | <strong>é£æ ¼ï¼š</strong>${s.style}</p>
              <p><strong>å™äº‹ï¼š</strong>${s.pov} | <strong>æ—¶æ€ï¼š</strong>${s.tense}</p>
              <p><strong>å‚æ•°ï¼š</strong>${s.chapterWords}å­—/ç«  | ä¸Šä¸‹æ–‡ ${s.contextMemory}ç«  | æ¸©åº¦ ${s.temperature}</p>
              ${s.characters ? `<p><strong>è§’è‰²ï¼š</strong><br>${s.characters.replace(/\n/g, '<br>')}</p>` : ''}
              ${s.world ? `<p><strong>ä¸–ç•Œè§‚ï¼š</strong><br>${s.world.replace(/\n/g, '<br>')}</p>` : ''}
              <p><strong>å¤§çº²ï¼š</strong><br>${s.outline.replace(/\n/g, '<br>')}</p>
          `;
          el('reviewContent').classList.remove('hidden');
          el('btnCollapseReview').textContent = 'æŠ˜å ';
      }

      // --- ä¹¦åº“ä¸ä¹¦ç±è¯¦æƒ… ---
      function saveCurrentBook() {
          if (!currentBook) return;
          const bookIndex = books.findIndex(b => b.id === currentBook.id);
          if (bookIndex !== -1) books[bookIndex] = currentBook;
          lsSet("books", books); lsSet("currentBook", currentBook);
      }
      function renderBookList() {
          const listEl = el("novelList"); listEl.innerHTML = "";
          if (books.length === 0) { listEl.innerHTML = "<p>ä½ è¿˜æ²¡æœ‰åˆ›ä½œä»»ä½•å°è¯´ã€‚å»â€œå†™ä½œè®¾å®šâ€é¡µå¼€å§‹ä½ çš„ç¬¬ä¸€æœ¬å§ï¼</p>"; return; }
          books.slice().sort((a, b) => b.createdAt - a.createdAt).forEach(book => {
              const card = document.createElement("div"); card.className = "novel-card";
              card.innerHTML = `<h3>${book.title}</h3><p class="novel-card-meta">åˆ›å»ºäº: ${new Date(book.createdAt).toLocaleDateString()} | ${book.chapters.length} ç« </p>`;
              card.onclick = () => openBookDetail(book);
              listEl.appendChild(card);
          });
      }
      function openBookDetail(book) {
          el('bookDetailTitle').textContent = book.title;
          el('bookDetailOutline').textContent = book.settings.outline;
          
          const btnContinue = el('btnBookDetailContinue');
          const btnDownloadActive = el('btnBookDetailDownload');
          const btnDeleteBook = el('btnBookDetailDelete');

          btnContinue.onclick = () => {
              currentBook = book;
              currentChapterIndex = book.chapters.length > 0 ? book.chapters.length - 1 : -1;
              saveCurrentBook();
              renderWriterView();
              el('bookDetailDialog').close();
              setView('writer');
          };
          btnDownloadActive.onclick = () => { el('bookDetailDialog').close(); openDownloadDialog(book.id); };
          btnDeleteBook.onclick = () => {
              el('bookDetailDialog').close();
              if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${book.title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                  books = books.filter(bItem => bItem.id !== book.id);
                  if (currentBook && currentBook.id === book.id) currentBook = null;
                  lsSet('books', books);
                  lsSet('currentBook', null);
                  renderBookList();
              }
          };
          
          const createChapterListItem = (chapter, isArchived = false) => {
              const li = document.createElement('li');
              const label = document.createElement('label');
              if (isArchived) {
                  const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'archive-checkbox'; checkbox.dataset.chapterId = chapter.id;
                  li.appendChild(checkbox);
              }
              label.textContent = isArchived ? `(å­˜æ¡£äº ${new Date(chapter.archivedAt).toLocaleDateString()}) ${chapter.title}` : `ç¬¬ ${chapter.index} ç« : ${chapter.title}`;
              label.onclick = (e) => { e.stopPropagation(); openReadChapter(chapter); };
              li.appendChild(label);
              return li;
          };
          
          el('activeChapterCount').textContent = book.chapters.length;
          const activeList = el('activeChaptersList'); activeList.innerHTML = '';
          book.chapters.forEach(ch => activeList.appendChild(createChapterListItem(ch)));

          el('archivedChapterCount').textContent = (book.archivedChapters || []).length;
          const archivedList = el('archivedChaptersList'); archivedList.innerHTML = '';
          (book.archivedChapters || []).sort((a,b) => b.archivedAt - a.archivedAt).forEach(ch => archivedList.appendChild(createChapterListItem(ch, true)));
          
          el('btnDownloadArchives').onclick = () => downloadArchivedChapters(book);

          el('bookDetailDialog').showModal();
      }
      el('closeBookDetail').onclick = () => el('bookDetailDialog').close();

      function openReadChapter(chapter) { el('readChapterTitle').textContent = chapter.title; el('readChapterContent').textContent = chapter.text; el('readChapterDialog').showModal(); }
      el('closeReadChapter').onclick = () => el('readChapterDialog').close();

      // --- API & æ¨¡å‹ç®¡ç† ---
      function saveConfigs() { lsSet("configs", configs); lsSet("activeCfgId", activeCfgId); }
      function getActiveCfg() { 
          const writerSelect = el('writerApiSelect');
          const configSelect = el('cfgSelect');
          const selectedId = writerSelect && !writerSelect.classList.contains('hidden') && writerSelect.value ? writerSelect.value : configSelect.value;
          return configs.find(c => c.id === selectedId) || null; 
      }
      function populateSelect(selectEl, items, valueField, textField, currentVal) { 
          selectEl.innerHTML = ""; 
          if (!items || items.length === 0) {
              const defaultOpt = document.createElement("option");
              defaultOpt.value = "";
              defaultOpt.textContent = "æ— å¯ç”¨æ¨¡å‹ / è¯·åŠ è½½APIé…ç½®";
              selectEl.appendChild(defaultOpt);
          }
          items.forEach(item => { const opt = document.createElement("option"); opt.value = item[valueField]; opt.textContent = typeof textField === 'function' ? textField(item) : item[textField]; selectEl.appendChild(opt); }); 
          if (currentVal && items.some(i => i[valueField] === currentVal)) { selectEl.value = currentVal; } 
      }
      function refreshAllConfigSelects() { 
          const currentCfgId = activeCfgId; 
          populateSelect(el("cfgSelect"), configs, 'id', c => `${c.name} (${c.provider})`, currentCfgId); 
          populateSelect(el("writerApiSelect"), configs, 'id', c => c.name, currentCfgId); 
      }
      el("cfgSelect").onchange = () => { 
          activeCfgId = el("cfgSelect").value; 
          el("writerApiSelect").value = activeCfgId; 
          saveConfigs(); 
          handleLoadModels(); 
      };
      el("writerApiSelect").onchange = () => { 
          activeCfgId = el("writerApiSelect").value; 
          el("cfgSelect").value = activeCfgId; 
          saveConfigs(); 
          handleLoadModels(); 
      };
      el("btnAddCfg").onclick = () => { 
          const name = el("cfgName").value.trim(), baseUrl = el("cfgBaseUrl").value.trim(), apiKey = el("cfgApiKey").value.trim(), provider = el("cfgProvider").value; 
          if (!name || !baseUrl || !apiKey) { el("cfgStatus").textContent = "è¯·å¡«å†™ é…ç½®åç§° / Base URL / API Key"; return; } 
          const newConfig = { id: crypto.randomUUID(), name, baseUrl, apiKey, provider, modelsCache: [] }; 
          configs.push(newConfig); activeCfgId = newConfig.id; saveConfigs(); 
          refreshAllConfigSelects(); 
          el("cfgStatus").textContent = `å·²ä¿å­˜é…ç½®ï¼š${name}ã€‚`; 
      };
      el("btnDeleteCfg").onclick = () => { 
          if (!activeCfgId) return; 
          configs = configs.filter(c => c.id !== activeCfgId); 
          activeCfgId = configs[0]?.id || null; 
          saveConfigs(); 
          refreshAllConfigSelects(); 
          modelList = []; 
          refreshAllModelSelects(); 
      };
      
      // --- ç›´æ¥è°ƒç”¨ API çš„å‡½æ•° ---
      async function testApiConnection(baseUrl, apiKey) {
          const url = `${baseUrl.replace(/\/+$/, '')}/models`;
          const response = await fetch(url, {
              headers: { 'Authorization': `Bearer ${apiKey}` }
          });
          if (!response.ok) {
              const err = await response.text();
              throw new Error(`HTTP ${response.status}: ${err.slice(0,200)}`);
          }
          const data = await response.json();
          // å…¼å®¹ OpenAI æ ¼å¼ { data: [ { id } ] } æˆ–ç›´æ¥æ•°ç»„
          const models = Array.isArray(data) ? data : (data.data || []);
          return models.map(m => ({ id: m.id })).filter(m => m.id);
      }

      async function chatCompletion(baseUrl, apiKey, model, messages, temperature) {
          const url = `${baseUrl.replace(/\/+$/, '')}/chat/completions`;
          const body = { model, messages, temperature, stream: false };
          const response = await fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
              },
              body: JSON.stringify(body)
          });
          const text = await response.text();
          if (!response.ok) {
              throw new Error(`APIé”™è¯¯ ${response.status}: ${text.slice(0,500)}`);
          }
          let data;
          try {
              data = JSON.parse(text);
          } catch {
              throw new Error(`è¿”å›éJSON: ${text.slice(0,200)}`);
          }
          const content = data?.choices?.[0]?.message?.content;
          if (typeof content !== 'string') throw new Error('APIè¿”å›æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ content');
          return { content, usage: data.usage, model: data.model };
      }

      // ä¿®æ”¹ handleLoadModelsï¼šä½¿ç”¨é€‰ä¸­çš„é…ç½®ç›´æ¥è·å–æ¨¡å‹åˆ—è¡¨
      async function handleLoadModels() {
          const cfg = getActiveCfg();
          if (!cfg) { el("cfgStatus").textContent = "è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆé…ç½®"; return; }
          const statusEl = el("cfgStatus");
          statusEl.textContent = `æ­£åœ¨ä» [${cfg.name}] åŠ è½½æ¨¡å‹...`;
          try {
              const models = await testApiConnection(cfg.baseUrl, cfg.apiKey);
              modelList = models;
              lsSet("modelList", modelList);
              refreshAllModelSelects();
              statusEl.textContent = `æˆåŠŸåŠ è½½ ${modelList.length} ä¸ªæ¨¡å‹ã€‚`;
              if (modelList.length > 0 && !activeModel()) setActiveModel(modelList[0].id);
          } catch (e) {
              statusEl.textContent = `åŠ è½½æ¨¡å‹å¤±è´¥: ${e.message}`;
          }
      }

      el("btnTestCfg").onclick = async () => {
          const baseUrl = el("cfgBaseUrl").value.trim();
          const apiKey = el("cfgApiKey").value.trim();
          const statusEl = el("cfgStatus");
          if (!baseUrl || !apiKey) { statusEl.textContent = "è¯·å¡«å†™ Base URL å’Œ API Key"; return; }
          statusEl.textContent = "æµ‹è¯•ä¸­...";
          try {
              const models = await testApiConnection(baseUrl, apiKey);
              statusEl.textContent = `æµ‹è¯•æˆåŠŸï¼Œå‘ç° ${models.length} ä¸ªæ¨¡å‹ã€‚`;
          } catch (e) {
              statusEl.textContent = `æµ‹è¯•å¤±è´¥: ${e.message}`;
          }
      };

      el("btnLoadModels").onclick = handleLoadModels;

      function activeModel() { 
          const writerModelSelect = el('writerModelSelect');
          const configModelSelect = el('modelSelect');
          const selectedModel = writerModelSelect && !writerModelSelect.classList.contains('hidden') && writerModelSelect.value ? writerModelSelect.value : configModelSelect.value;
          return selectedModel || lsGet("activeModel", "");
      }
      function refreshAllModelSelects() { 
          const currentModel = activeModel(); 
          populateSelect(el("modelSelect"), modelList, 'id', 'id', currentModel); 
          populateSelect(el("writerModelSelect"), modelList, 'id', 'id', currentModel); 
          lsSet("modelList", modelList); 
      }
      function setActiveModel(modelId) { 
          lsSet("activeModel", modelId); 
          el('modelSelect').value = modelId; 
          el('writerModelSelect').value = modelId; 
      }
      el('modelSelect').onchange = () => setActiveModel(el('modelSelect').value);

      // --- å†™ä½œè®¾å®šé¡µäº¤äº’ ---
      el('contextMemory').oninput = () => { el('contextMemoryValue').textContent = el('contextMemory').value; };

      function loadSettingsFromBook(book) { 
          if (!book) return; 
          const s = book.settings; 
          el('novelTitle').value = book.title; 
          el('novelGenre').value = s.genre; el('novelStyle').value = s.style; el('chapterWords').value = s.chapterWords; 
          el('novelPOV').value = s.pov; el('novelTense').value = s.tense; el('temperature').value = s.temperature; 
          el('contextMemory').value = s.contextMemory; el('contextMemoryValue').textContent = s.contextMemory;
          el('aiPersona').value = s.aiPersona; el('novelOutline').value = s.outline; 
          el('novelCharacters').value = s.characters; 
          el('novelWorld').value = s.world; 
      }
      function loadPersonaHistory() { const sel = el('personaHistory'); sel.innerHTML = '<option value="">é€‰æ‹©å†å²æ¨¡æ¿...</option>'; personaHistory.forEach((p, i) => { const opt = document.createElement('option'); opt.value = i; opt.textContent = p.substring(0, 30) + '...'; sel.appendChild(opt); }); }
      el('btnLoadPersona').onclick = () => { const idx = el('personaHistory').value; if (idx !== "") el('aiPersona').value = personaHistory[idx]; };
      el('btnSavePersona').onclick = () => { const currentPersona = el('aiPersona').value.trim(); if (currentPersona && !personaHistory.includes(currentPersona)) { personaHistory.push(currentPersona); lsSet('personaHistory', personaHistory); loadPersonaHistory(); alert('æ¨¡æ¿å·²ä¿å­˜ï¼'); } };
      function refreshOutlineHistory() { const sel = el("outlineHistory"); sel.innerHTML = '<option value="">å†å²ç‰ˆæœ¬...</option>'; outlineHistory.slice().sort((a, b) => b.ts - a.ts).forEach(h => { const opt = document.createElement("option"); opt.value = String(h.ts); opt.textContent = new Date(h.ts).toLocaleString(); sel.appendChild(opt); }); }
      el("btnRestoreOutline").onclick = () => { const ts = Number(el("outlineHistory").value); if (ts) { const h = outlineHistory.find(x => x.ts === ts); if (h) el("novelOutline").value = h.text; } };
      function pushOutlineHistory(text) { outlineHistory.push({ ts: Date.now(), text }); outlineHistory = outlineHistory.slice(-30); lsSet("outlineHistory", outlineHistory); refreshOutlineHistory(); }
      
      // é‡å†™ btnImproveOutlineï¼Œç›´æ¥è°ƒç”¨ chatCompletion
      el("btnImproveOutline").onclick = async () => {
          const outline = el("novelOutline").value.trim();
          const statusEl = el("setupMeta");
          if (!outline) { statusEl.textContent = "è¯·å…ˆå¡«å†™å¤§çº²ã€‚"; return; }
          pushOutlineHistory(outline);
          const userPrompt = `è¯·å°†ä»¥ä¸‹ç”¨æˆ·è‰ç¨¿å¤§çº²ï¼Œå®Œå–„æˆä¸€ä¸ªç»“æ„æ›´æ¸…æ™°ã€å†²çªæ›´æ˜ç¡®ã€åŒ…å«èµ·æ‰¿è½¬åˆçš„è¯¦ç»†å¤§çº²ï¼Œå¹¶ç»™å‡ºå‰3ç« çš„ç« èŠ‚è¦ç‚¹ã€‚åªè¾“å‡ºå¤§çº²æ–‡æœ¬ã€‚\n\nç”¨æˆ·è‰ç¨¿å¤§çº²ï¼š\n${outline}`;
          const messages = [ { role: "system", content: "ä½ æ˜¯ä¸€ä½èµ„æ·±å°è¯´ç¼–è¾‘..." }, { role: "user", content: userPrompt } ];
          const cfg = getActiveCfg();
          const model = activeModel();
          if (!cfg || !model) { statusEl.textContent = "è¯·é€‰æ‹©APIçº¿è·¯å’Œæ¨¡å‹ã€‚"; return; }
          statusEl.textContent = 'æ­£åœ¨è¯·æ±‚...';
          try {
              const res = await chatCompletion(cfg.baseUrl, cfg.apiKey, model, messages, Number(currentBook?.settings.temperature || 0.8));
              const newOutline = res.content.trim();
              el("novelOutline").value = newOutline;
              pushOutlineHistory(newOutline);
              statusEl.textContent = `å¤§çº²å·²å®Œå–„ã€‚ | æ¨¡å‹: ${res.model}`;
          } catch (e) {
              statusEl.textContent = `é”™è¯¯: ${e.message}`;
          }
      };

      // --- Prompt æ„å»ºä¸ AI è°ƒç”¨ ---
      function buildMasterSystemPrompt() { return el("aiPersona").value.trim() || "ä½ æ˜¯ä¸€ä½ç²¾é€šå„ç§é¢˜æçš„èŒä¸šå°è¯´å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„è®¾å®šå’Œå¤§çº²ï¼Œåˆ›ä½œå‡ºæƒ…èŠ‚è¿è´¯ã€æ–‡ç¬”ä¼˜ç¾ã€å¼•äººå…¥èƒœçš„ç« èŠ‚å†…å®¹ã€‚"; }
      function buildChapterSystemPrompt() { return `è¯·ä¸¥æ ¼æŒ‰ç…§æœ¬å°è¯´çš„è®¾å®šè§„åˆ™ã€äººç§°ã€æ—¶æ€å’Œé£æ ¼è¿›è¡Œåˆ›ä½œï¼Œä¿æŒæƒ…èŠ‚æ¨è¿›å’Œäººç‰©å¼§å…‰ã€‚`; }

      // é‡å†™ callApiï¼šç°åœ¨ç›´æ¥è°ƒç”¨ APIï¼Œå…¼å®¹åŸæœ‰è°ƒç”¨æ–¹å¼
      async function callApi(endpoint, body, buttonEl, statusEl) {
          const originalText = buttonEl.textContent;
          buttonEl.disabled = true;
          buttonEl.textContent = "å¤„ç†ä¸­...";
          statusEl.textContent = 'æ­£åœ¨å‡†å¤‡è¯·æ±‚...';
          const startTime = Date.now();
          try {
              const { baseUrl, apiKey, model, messages, temperature } = body;
              if (!baseUrl || !apiKey || !model || !messages) {
                  throw new Error('ç¼ºå°‘å¿…è¦å‚æ•° baseUrl/apiKey/model/messages');
              }
              const url = `${baseUrl.replace(/\/+$/, '')}/chat/completions`;
              const reqBody = {
                  model,
                  messages,
                  temperature: temperature || 0.8,
                  stream: false
              };
              const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${apiKey}`
                  },
                  body: JSON.stringify(reqBody)
              });
              const text = await response.text();
              if (!response.ok) {
                  throw new Error(`API é”™è¯¯ (çŠ¶æ€ç : ${response.status}): ${text.slice(0,200)}`);
              }
              const data = JSON.parse(text);
              const latency = Date.now() - startTime;
              statusEl.textContent = 'ç”ŸæˆæˆåŠŸï¼';
              return {
                  ok: true,
                  latency_ms: latency,
                  model: data.model || model,
                  usage: data.usage,
                  raw: data
              };
          } catch (e) {
              statusEl.textContent = `è¯·æ±‚å¤±è´¥: ${e.message}`;
              return { ok: false, error: e.message };
          } finally {
              buttonEl.disabled = false;
              buttonEl.textContent = originalText;
          }
      }

      // --- æ ¸å¿ƒåˆ›ä½œæµç¨‹ ---
      function renderWriterView() {
          if (!currentBook || currentBook.chapters.length === 0) { setView('novels'); return; }
          const ch = currentBook.chapters[currentChapterIndex];
          el('writerChapterTitle').textContent = `${currentBook.title} - ${ch.title}`;
          el('chapterIndicator').textContent = `ç¬¬ ${currentChapterIndex + 1} / ${currentBook.chapters.length} ç« `;
          el('chapterOutput').textContent = ch.text;
          el('genMeta').textContent = ch.meta;
          el('btnPrevChapter').disabled = currentChapterIndex === 0;
          el('btnNextChapter').disabled = currentChapterIndex === currentBook.chapters.length - 1;
          el('rewriteContainer').classList.remove('hidden');
          const isLast = currentChapterIndex === currentBook.chapters.length - 1;
          el('continueContainer').classList.toggle('hidden', !isLast);
          renderSettingsReview();

          if (isLast) {
              const opts = el('nextOptions'); opts.innerHTML = '';
              (ch.nextOptions || []).forEach(opt => {
                  const b = document.createElement('button'); b.className = 'secondary'; b.textContent = opt;
                  b.onclick = () => el('nextPlot').value = opt;
                  opts.appendChild(b);
              });
          }
      }
      el('btnPrevChapter').onclick = () => { if (currentChapterIndex > 0) { currentChapterIndex--; renderWriterView(); } };
      el('btnNextChapter').onclick = () => { if (currentChapterIndex < currentBook.chapters.length - 1) { currentChapterIndex++; renderWriterView(); } };

      async function generateChapter(nextPlotHint = "", isRewrite = false) {
          const isFirstChapter = currentBook.chapters.length === 0 && !isRewrite;
          const btn = isFirstChapter ? el("btnStart") : (isRewrite ? el('btnRewriteChapter') : el('btnNext'));
          const metaEl = isFirstChapter ? el("setupMeta") : (isRewrite ? el('rewriteMeta') : el('genMeta'));
          const cfg = getActiveCfg(); const model = activeModel();
          if (!cfg || !model) { metaEl.textContent = "é”™è¯¯: è¯·é€‰æ‹©æœ‰æ•ˆçš„ API çº¿è·¯å’Œæ¨¡å‹ã€‚"; return; }
          const chapterIndex = currentBook.chapters.length + 1;
          const words = Number(currentBook.settings.chapterWords);
          const memoryCount = Number(currentBook.settings.contextMemory);
          const memory = memoryCount > 0 ? currentBook.chapters.slice(-memoryCount).map(c => `ã€ç¬¬${c.index}ç« å›é¡¾ã€‘\n${c.text.substring(0, 500)}...`).join("\n\n") : "";
          
          const fullSystemPrompt = `ä½ æ˜¯ä¸€åèŒä¸šå°è¯´å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¸å¿ƒè®¾å®šæ¥åˆ›ä½œã€‚
          
          # å°è¯´æ ¸å¿ƒè®¾å®š (ä¸å¯ä¿®æ”¹)
          ${el('reviewContent').innerText.trim()}
          
          # å†™ä½œè¦æ±‚
          ${buildChapterSystemPrompt()}
          `;

          const userPrompt = `è¯·æ ¹æ®ä»¥ä¸Šè®¾å®šï¼Œåˆ›ä½œç¬¬ ${chapterIndex} ç« ï¼Œç›®æ ‡å­—æ•°çº¦ ${words} å­—ã€‚
          ${memory ? `ä¸ºä¿è¯è¿ç»­æ€§ï¼Œä»¥ä¸‹æ˜¯æœ€è¿‘ ${memoryCount} ç« å›é¡¾ï¼š\n${memory}\n` : ""}
          ${nextPlotHint ? `æœ¬ç« å‰§æƒ…é‡ç‚¹æç¤ºï¼ˆè¯·ä¼˜å…ˆéµå¾ªæ­¤æç¤ºå±•å¼€ï¼‰ï¼š${nextPlotHint}\n` : ""}
          
          è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆä¸¥æ ¼éµå®ˆï¼‰ï¼š
          ### [æ­¤å¤„å¡«å†™ç« èŠ‚æ ‡é¢˜]
          [æ­¤å¤„å¼€å§‹ç« èŠ‚æ­£æ–‡]
          
          ---
          #### åç»­å‘å±•å»ºè®®
          - [å»ºè®®1]
          - [å»ºè®®2]
          - [å»ºè®®3]`;

          const messages = [ { role:"system", content: fullSystemPrompt }, { role: "user", content: userPrompt } ];
          const res = await callApi("/api/chat", { ...cfg, model, messages, temperature: Number(currentBook.settings.temperature) }, btn, metaEl);
          if (!res.ok) { metaEl.textContent = `é”™è¯¯: ${res.error || "ç”Ÿæˆå¤±è´¥"}`; return; }
          const content = res.raw.choices?.[0]?.message?.content?.trim() || "";
          const parts = content.split('---'), mainContent = parts[0] || "", suggestionsPart = parts[1] || "";
          const nextOptions = (suggestionsPart.match(/[-*]\s*(.+)/g) || []).map(s => s.replace(/[-*]\s*/, '').trim());
          const titleMatch = mainContent.match(/###\s*(.*)/), title = titleMatch ? titleMatch[1].trim() : `ç¬¬ ${chapterIndex} ç« `;
          const text = mainContent.replace(/###.*/, '').trim();
          const usage = res.usage ? `P:${res.usage.prompt_tokens}, C:${res.usage.completion_tokens}, T:${res.usage.total_tokens}` : "N/A";
          const metaText = `æ¨¡å‹: ${res.model} | è€—æ—¶: ${res.latency_ms}ms | Tokens: ${usage} | å­—æ•°: ${text.length}`;
          const newChapter = { id: crypto.randomUUID(), index: chapterIndex, title, text, meta: metaText, nextOptions };
          currentBook.chapters.push(newChapter);
          currentChapterIndex = currentBook.chapters.length - 1;
          saveCurrentBook();
          renderWriterView();
          el('rewritePlot').value = '';
          if (isFirstChapter) setView("writer");
      }

      el("btnStart").onclick = () => {
        try {
          const required = { "novelTitle": "å°è¯´ä¹¦å", "novelGenre": "ç±»å‹", "novelStyle": "é£æ ¼", "novelOutline": "å¤§çº²", "chapterWords": "å­—æ•°" };
          for (const id in required) { 
              const inputEl = el(id);
              if (inputEl && !inputEl.value.trim()) {
                  throw new Error(`è¯·å¡«å†™ "${document.querySelector(`label[for=${id}]`).textContent.replace(' (å¿…å¡«)', '')}"`); 
              }
          }
          currentBook = { 
              id: crypto.randomUUID(), 
              title: el('novelTitle').value.trim(), 
              createdAt: Date.now(), 
              chapters: [], 
              archivedChapters: [], 
              settings: { 
                  genre: el('novelGenre').value, style: el('novelStyle').value, chapterWords: el('chapterWords').value, 
                  pov: el('novelPOV').value, tense: el('novelTense').value, temperature: el('temperature').value, 
                  contextMemory: el('contextMemory').value, 
                  aiPersona: el('aiPersona').value, outline: el('novelOutline').value, 
                  characters: el('novelCharacters').value,
                  world: el('novelWorld').value,
              } 
          };
          books.push(currentBook); currentChapterIndex = -1; saveCurrentBook();
          const currentPersona = el('aiPersona').value.trim();
          if (currentPersona && !personaHistory.includes(currentPersona)) { personaHistory.push(currentPersona); lsSet('personaHistory', personaHistory); loadPersonaHistory(); }
          renderSettingsReview();
          generateChapter();
        } catch (e) { el("setupMeta").textContent = e.message; }
      };
      el("btnNext").onclick = () => { generateChapter(el("nextPlot").value.trim()); el("nextPlot").value = ""; };
      el("btnRewriteChapter").onclick = async () => {
          if (!currentBook) return;
          const rewritePlot = el('rewritePlot').value.trim();
          if (!rewritePlot) { el('rewriteMeta').textContent = 'è¯·è¾“å…¥æ–°çš„å‰§æƒ…èµ°å‘ã€‚'; return; }
          const isLastChapter = currentChapterIndex === currentBook.chapters.length - 1;
          const confirmMessage = isLastChapter ? `ç¡®å®šè¦é‡å†™ç¬¬ ${currentChapterIndex + 1} ç« å—ï¼Ÿæ­¤ç« èŠ‚çš„å½“å‰ç‰ˆæœ¬å°†è¢«å­˜æ¡£ã€‚` : `ç¡®å®šè¦é‡å†™ç¬¬ ${currentChapterIndex + 1} ç« å—ï¼Ÿæ­¤ç« èŠ‚ä»¥åŠä¹‹åçš„æ‰€æœ‰ç« èŠ‚éƒ½å°†è¢«å­˜æ¡£ã€‚`;
          if (!confirm(confirmMessage)) return;
          const chapterToArchive = currentBook.chapters[currentChapterIndex];
          if (!currentBook.archivedChapters) currentBook.archivedChapters = [];
          currentBook.archivedChapters.push({ ...chapterToArchive, archivedAt: Date.now() });
          if (!isLastChapter) {
              const chaptersToArchiveLater = currentBook.chapters.slice(currentChapterIndex + 1);
              chaptersToArchiveLater.forEach(ch => { currentBook.archivedChapters.push({ ...ch, archivedAt: Date.now() }); });
          }
          currentBook.chapters = currentBook.chapters.slice(0, currentChapterIndex);
          await generateChapter(rewritePlot, true);
      };

      // --- ä¸‹è½½åŠŸèƒ½ ---
      function openDownloadDialog(bookId) {
          bookToDownloadId = bookId;
          el('downloadDialog').showModal();
      }
      async function downloadArchivedChapters(book) {
          if (!book) return;
          const checkedBoxes = document.querySelectorAll('#archivedChaptersList .archive-checkbox:checked');
          if (checkedBoxes.length === 0) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦ä¸‹è½½çš„å­˜æ¡£ç« èŠ‚ã€‚'); return; }
          const chapterIds = Array.from(checkedBoxes).map(cb => cb.dataset.chapterId);
          const chaptersToDownload = (book.archivedChapters || []).filter(ch => chapterIds.includes(ch.id));
          if (chaptersToDownload.length === 1) {
              const chapter = chaptersToDownload[0];
              const content = `ã€${chapter.title} (å­˜æ¡£äº ${new Date(chapter.archivedAt).toLocaleString()})ã€‘\n\n${chapter.text}`;
              const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
              triggerDownload(blob, `[å­˜æ¡£] ${book.title} - ${chapter.title}.txt`);
          } else if (chaptersToDownload.length > 1) {
              // ç¡®ä¿ JSZip å­˜åœ¨
              if (typeof JSZip === 'undefined') {
                  alert('é”™è¯¯ï¼šJSZip åº“æœªåŠ è½½ï¼Œæ— æ³•æ‰“åŒ…ä¸‹è½½ã€‚è¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œã€‚');
                  return;
              }
              const zip = new JSZip();
              chaptersToDownload.forEach(chapter => {
                  const filename = `ç¬¬${chapter.index}ç«  - ${chapter.title.replace(/[\\/:*?"<>|]/g, '_')}.txt`;
                  zip.file(filename, chapter.text);
              });
              const blob = await zip.generateAsync({ type: 'blob' });
              triggerDownload(blob, `[å­˜æ¡£] ${book.title} (${chaptersToDownload.length}ç« ).zip`);
          }
      }
      function triggerDownload(blob, filename) { const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
      async function downloadBook(format) {
          const book = books.find(b => b.id === bookToDownloadId);
          if (!book) return;
          const filename = book.title.replace(/[\\/:*?"<>|]/g, '_');
          if (format === 'txt-single') { 
              const content = book.chapters.map(c => `ã€${c.title}ã€‘\n\n${c.text}`).join('\n\n---\n\n'); 
              const blob = new Blob([content], { type: 'text/plain;charset=utf-8' }); 
              triggerDownload(blob, `${filename}.txt`); 
          } else if (format === 'html-single') { 
              const chapterHtml = book.chapters.map(c => `<h2>${c.title}</h2>\n<pre>${c.text}</pre>`).join('\n<hr>\n'); 
              const content = `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>${book.title}</title><style>body{line-height:1.7;max-width:800px;margin:20px auto;padding:20px;font-family:sans-serif;} pre{white-space:pre-wrap;word-wrap:break-word;}</style></head><body><h1>${book.title}</h1>${chapterHtml}</body></html>`; 
              const blob = new Blob([content], { type: 'text/html;charset=utf-8' }); 
              triggerDownload(blob, `${filename}.html`); 
          } else if (format === 'zip-txt') { 
              if (typeof JSZip === 'undefined') { alert('JSZip æœªåŠ è½½'); return; }
              const zip = new JSZip(); 
              book.chapters.forEach(c => zip.file(`ç¬¬${c.index}ç«  - ${c.title.replace(/[\\/:*?"<>|]/g, '_')}.txt`, c.text)); 
              const blob = await zip.generateAsync({ type: 'blob' }); 
              triggerDownload(blob, `${filename}.zip`); 
          } else if (format === 'zip-html') { 
              if (typeof JSZip === 'undefined') { alert('JSZip æœªåŠ è½½'); return; }
              const zip = new JSZip(); 
              book.chapters.forEach(c => { const chapterContent = `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>${c.title}</title><style>body{line-height:1.7;max-width:800px;margin:20px auto;padding:20px;font-family:sans-serif;} pre{white-space:pre-wrap;word-wrap:break-word;}</style></head><body><h1>${c.title}</h1><pre>${c.text}</pre></body></html>`; zip.file(`ç¬¬${c.index}ç«  - ${c.title.replace(/[\\/:*?"<>|]/g, '_')}.html`, chapterContent); }); 
              const blob = await zip.generateAsync({ type: 'blob' }); 
              triggerDownload(blob, `${filename}.zip`); 
          }
      }
      el('btnCancelDownload').onclick = () => { el('downloadDialog').close(); bookToDownloadId = null; };
      el('btnConfirmDownload').onclick = () => { downloadBook(el('downloadFormat').value); el('downloadDialog').close(); bookToDownloadId = null; };

      // --- åˆå§‹åŒ– ---
      function initialize() {
          // æ•°æ®è¿ç§»ï¼šä¸ºæ—§ç« èŠ‚æ·»åŠ å”¯ä¸€ID
          let migrationNeeded = false;
          books.forEach(book => {
              (book.chapters || []).forEach(ch => { if (!ch.id) { ch.id = crypto.randomUUID(); migrationNeeded = true; }});
              (book.archivedChapters || []).forEach(ch => { if (!ch.id) { ch.id = crypto.randomUUID(); migrationNeeded = true; }});
              if (book.settings) {
                  if (typeof book.settings.characters === 'undefined') { book.settings.characters = ''; migrationNeeded = true; }
                  if (typeof book.settings.world === 'undefined') { book.settings.world = ''; migrationNeeded = true; }
              }
          });
          if (migrationNeeded) { lsSet('books', books); console.log("Data migration: Chapter IDs and settings defaults added."); }
          
          applyUISettings();
          refreshAllConfigSelects();
          refreshAllModelSelects();
          refreshOutlineHistory();
          loadPersonaHistory();

          if (currentBook && currentBook.chapters.length > 0) {
              currentChapterIndex = currentBook.chapters.length - 1;
              renderWriterView();
              setView('writer');
          } else {
              setView('novels');
          }
          if (configs.length > 0 && modelList.length === 0) { handleLoadModels(); }

          if (el('reviewContent')) {
              el('reviewContent').classList.remove('hidden');
              el('btnCollapseReview').textContent = 'æŠ˜å ';
          }

          if (el('btnCollapseReview')) {
              el('btnCollapseReview').onclick = () => {
                  const content = el('reviewContent');
                  const btn = el('btnCollapseReview');
                  const isHidden = content.classList.toggle('hidden');
                  btn.textContent = isHidden ? 'å±•å¼€' : 'æŠ˜å ';
              };
          }
      }

      initialize();
    })();
  </script>
</body>
</html>