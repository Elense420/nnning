<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>AI æ¼«å‰§åˆ†é•œå·¥ä½œå°</title>
  <style>
    /* --- å…¨å±€ä¸ä¸»é¢˜ --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #e9ecf1 100%);
      --bg-main: #f8f9fa;
      --panel: #ffffff;
      --text: #212529;
      --text-muted: #6c757d;
      --text-light: #495057;
      --line: #e9ecef;
      --brand: #4a69ff;
      --brand-hover: #3b53cc;
      --brand-light: #eef2ff;
      --ok: #198754;
      --bad: #dc3545;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.04);
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif;
      --font-mono: 'SFMono-Regular', Consolas, "Liberation Mono", Menlo, Courier, monospace;
    }
    body.dark-mode {
      --bg-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
      --bg-main: #212123;
      --panel: #2c2c2e;
      --text: #f0f0f0;
      --text-muted: #9a9a9e;
      --text-light: #d1d1d6;
      --line: #3a3a3c;
      --brand-light: rgba(74, 105, 255, 0.2);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: var(--font-sans);
      color: var(--text);
      background: var(--bg-gradient);
      overflow: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- é¡µé¢ä¸å¸ƒå±€ --- */
    #setup-page, #app-container { width: 100%; height: 100%; transition: opacity 0.3s ease; }
    .hidden { display: none !important; }
    #setup-page { display: flex; align-items: center; justify-content: center; padding: 20px; }
    .setup-card {
      width: 100%; max-width: 520px; background: var(--panel); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 32px; display: flex; flex-direction: column; gap: 24px;
    }
    .setup-card h1 { margin: 0; font-size: 1.75rem; text-align: center; }
    .setup-card .subtitle { text-align: center; margin-top: -16px; color: var(--text-muted); }

    #app-container { display: flex; flex-direction: column; height: 100%; padding: 20px; gap: 16px; }
    #app-header {
      background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow-sm);
      padding: 12px 20px; display: flex; align-items: center; gap: 20px; flex-shrink: 0;
    }
    #app-nav button { background: none; border: none; font-size: 1rem; color: var(--text-muted); font-weight: 500; cursor: pointer; }
    #app-nav button.active { color: var(--brand); font-weight: 700; }
    #main-app { flex-grow: 1; display: grid; grid-template-columns: 420px 1fr; gap: 16px; min-height: 0; }
    .page-content { display: contents; }
    .control-panel, .output-panel {
      background: var(--panel); border-radius: var(--radius); box-shadow: var(--shadow-sm);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .panel-header {
      padding: 16px 20px; border-bottom: 1px solid var(--line);
      display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
    }
    .panel-header h2 { margin: 0; font-size: 1.2rem; }
    .panel-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; }

    /* --- é€šç”¨ç»„ä»¶ --- */
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .form-group label { font-weight: 500; font-size: 0.9rem; color: var(--text-light); }
    input, select, button, textarea {
      font-family: inherit; font-size: 1rem; padding: 10px 14px;
      border: 1px solid var(--line); border-radius: 8px; background: var(--bg-main);
      color: var(--text); transition: all 0.2s ease;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px var(--brand-light); }
    button { cursor: pointer; font-weight: 600; color: #fff; background: var(--brand); border-color: var(--brand); }
    button:hover { background: var(--brand-hover); border-color: var(--brand-hover); }
    button.secondary { background: var(--brand-light); color: var(--brand); border-color: var(--line); }
    body.dark-mode button.secondary { border-color: #444; }
    button.secondary:hover { background: #dbe4ff; }
    body.dark-mode button.secondary:hover { background: rgba(74, 105, 255, 0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hr { height: 1px; background: var(--line); margin: 8px 0; }
    .mini { font-size: 0.9rem; padding: 6px 12px; }
    .icon-btn { background: none; border: none; width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; padding: 0; border-radius: 50%; cursor: pointer; }
    .icon-btn:hover { background: var(--bg-main); }
    .spacer { flex: 1; }

    /* --- ç‰¹å®šç»„ä»¶ --- */
    .drop-zone {
      border: 2px dashed var(--line); border-radius: var(--radius); padding: 40px 20px;
      text-align: center; color: var(--text-muted); transition: all 0.2s ease;
    }
    .drop-zone.dragover { border-color: var(--brand); background: var(--brand-light); }
    .toggle-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
    .toggle-buttons button { background: var(--bg-main); color: var(--text-light); border: 1px solid var(--line); }
    .toggle-buttons button.active { background: var(--brand-light); color: var(--brand); border-color: var(--brand); font-weight: 700; }
    .output-area { flex-grow: 1; font-family: var(--font-mono); font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; color: var(--text-light); background: var(--bg-main); padding: 16px; border-radius: 8px; }
    .output-area:empty::before { content: 'ç”Ÿæˆçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...'; color: var(--text-muted); }
    #generation-info { font-size: 0.8rem; color: var(--text-muted); padding-top: 12px; border-top: 1px dashed var(--line); margin-top: auto; }
    
    /* --- Modals --- */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        display: none; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-content {
        width: 90%; max-width: 600px; background: var(--panel);
        border-radius: var(--radius); box-shadow: var(--shadow);
        max-height: 80vh; display: flex; flex-direction: column;
    }
    .modal-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
    .modal-item {
        padding: 12px 20px; border-bottom: 1px solid var(--line);
        display: flex; justify-content: space-between; align-items: center; gap: 10px;
    }
    .modal-item:hover { background-color: var(--bg-main); }
    .modal-item:last-child { border-bottom: none; }
    .modal-item .name { font-weight: 500; flex-grow: 1;}
    .modal-item .details { font-size: 0.8rem; color: var(--text-muted); }
  </style>
</head>
<body class="dark-mode">

  <!-- ===================== é…ç½®é¡µé¢ ======================= -->
  <div id="setup-page">
    <div class="setup-card">
        <h1>AI åˆ†é•œå·¥ä½œå°</h1>
        <p class="subtitle">å¼€å§‹å‰ï¼Œè¯·å…ˆé…ç½®æ‚¨çš„ API</p>
        <div class="form-group"><label for="cfg-select">å·²ä¿å­˜çš„é…ç½®</label><select id="cfg-select"></select></div>
        <div class="hr"></div>
        <div class="form-group"><label for="cfg-name">é…ç½®åç§°</label><input id="cfg-name" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„ä¸»åŠ›API"></div>
        <div class="form-group"><label for="cfg-baseurl">Base URL</label><input id="cfg-baseurl" placeholder="https://api.example.com/v1"></div>
        <div class="form-group"><label for="cfg-apikey">API Key</label><input id="cfg-apikey" type="password" placeholder="sk-..."></div>
        <div class="form-group"><label for="cfg-model">é»˜è®¤æ¨¡å‹ (åŠ è½½åé€‰æ‹©)</label><select id="cfg-model"></select></div>
        <div style="display: flex; gap: 10px;">
            <button id="btn-save-cfg">ä¿å­˜é…ç½®</button>
            <button id="btn-fetch-models" class="secondary">åŠ è½½æ¨¡å‹</button>
        </div>
        <div id="status-area" style="text-align:center; min-height: 20px;"></div>
        <button id="btn-continue" disabled>è¿›å…¥å·¥ä½œå°</button>
    </div>
  </div>

  <!-- ===================== ä¸»åº”ç”¨å®¹å™¨ ===================== -->
  <div id="app-container" class="hidden">
    <header id="app-header">
      <nav id="app-nav">
        <button data-page="storyboard-page">åˆ†é•œè„šæœ¬ç”Ÿæˆ</button>
        <button data-page="image-prompt-page">åˆ†é•œå›¾æç¤ºè¯</button>
      </nav>
      <div class="spacer"></div>
      <button id="btn-back-to-setup" class="secondary mini">è¿”å›é…ç½®</button>
      <button id="btn-switch-api" class="secondary mini">åˆ‡æ¢ API / æ¨¡å‹</button>
      <button id="btn-toggle-darkmode" class="icon-btn" title="åˆ‡æ¢æ¨¡å¼"></button>
      <button id="btn-history" class="secondary mini">ğŸ“‹ å†å²è®°å½•</button>
    </header>

    <main id="main-app">
      <!-- åˆ†é•œè„šæœ¬ç”Ÿæˆé¡µ (ä¿æŒä¸å˜) -->
      <div id="storyboard-page" class="page-content hidden">
        <div class="control-panel">
          <div class="panel-header"><h2>æ§åˆ¶é¢æ¿</h2></div>
          <div class="panel-body">
            <div class="form-group"><label>1. è¾“å…¥æˆ–æ‹–å…¥å‰§æœ¬</label><div class="drop-zone" id="drop-zone-storyboard">å°† .txt æˆ– .md æ–‡ä»¶æ‹–åˆ°æ­¤å¤„</div><textarea id="script-input" placeholder="æˆ–åœ¨æ­¤å¤„ç²˜è´´ä½ çš„å‰§æœ¬..."></textarea></div>
            <div class="form-group"><label>2. è®¾å®šåˆ†é•œå‚æ•°</label>
                <div class="toggle-buttons" id="aspect-ratio-btns"><button data-value="æ¨ªç‰ˆ" class="active">æ¨ªç‰ˆ</button><button data-value="ç«–ç‰ˆ">ç«–ç‰ˆ</button></div>
                <div class="toggle-buttons" id="style-btns">
                  <button data-value="2DåŠ¨ç”»" class="active">2DåŠ¨ç”»</button>
                  <button data-value="3DåŠ¨ç”»">3DåŠ¨ç”»</button>
                  <button data-value="å†™å®ç”µå½±">å†™å®ç”µå½±</button>
                  <button data-value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</button>
                </div>
                <input id="custom-style-input" placeholder="è¾“å…¥è‡ªå®šä¹‰é£æ ¼ï¼Œå¦‚ï¼šæ°´å¢¨ã€èµ›åšæœ‹å…‹..." style="display: none;">
                <div class="toggle-buttons" id="duration-btns"><button data-value="1åˆ†é’Ÿ">1åˆ†é’Ÿ</button><button data-value="2åˆ†é’Ÿ">2åˆ†é’Ÿ</button><button data-value="3åˆ†é’Ÿ" class="active">3åˆ†é’Ÿ</button><button data-value="4åˆ†é’Ÿ">4åˆ†é’Ÿ</button></div>
                <input id="custom-duration-input" type="number" placeholder="æˆ–è‡ªå®šä¹‰ç§’æ•°, å¦‚: 90">
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                  <input id="shot-count" type="number" placeholder="åˆ†é•œæ•° (é€‰å¡«)" style="flex-grow: 1;">
                  <button id="shot-count-auto" class="secondary" style="width: 120px;">AIè‡ªåŠ¨é€‚é…</button>
                </div>
            </div>
            <div class="form-group"><label>3. è¾“å…¥æ ¸å¿ƒæŒ‡ä»¤</label><textarea id="instruction-input" placeholder="å‘Šè¯‰AIå®ƒçš„ä»»åŠ¡..."></textarea><button id="btn-manage-prompts" class="secondary">ç®¡ç†å’Œä½¿ç”¨æŒ‡ä»¤æ¨¡æ¿</button></div>
            <button id="btn-generate-storyboard" style="margin-top: auto; padding: 14px;">âœ¨ ç”Ÿæˆåˆ†é•œè„šæœ¬</button>
          </div>
        </div>
        <div class="output-panel">
          <div class="panel-header"><h2>ç”Ÿæˆç»“æœ</h2><div><button id="btn-copy-storyboard" class="secondary mini">å¤åˆ¶</button><button id="btn-download-storyboard" class="secondary mini">ä¸‹è½½ .txt</button></div></div>
          <div class="panel-body"><div id="output-area-storyboard" class="output-area"></div><div id="generation-info-storyboard" class="generation-info"></div></div>
        </div>
      </div>

      <!-- åˆ†é•œå›¾æç¤ºè¯é¡µ -->
      <div id="image-prompt-page" class="page-content hidden">
        <div class="control-panel">
          <div class="panel-header"><h2>æ§åˆ¶é¢æ¿</h2></div>
          <div class="panel-body">
            <div class="form-group"><label>1. åŸå‰§æœ¬ï¼ˆåŸå§‹æ•…äº‹ï¼‰</label><div class="drop-zone" id="drop-zone-original">å°† .txt æˆ– .md æ–‡ä»¶æ‹–åˆ°æ­¤å¤„</div><textarea id="original-script-input" placeholder="ç²˜è´´ä½ çš„åŸå‰§æœ¬..." rows="6"></textarea></div>
            
            <div class="form-group">
              <label>2. åˆ†é•œè„šæœ¬ï¼ˆå·²ç”Ÿæˆçš„åˆ†é•œï¼‰</label>
              <div class="drop-zone" id="drop-zone-storyboard-script">å°† .txt æˆ– .md æ–‡ä»¶æ‹–åˆ°æ­¤å¤„</div>
              <textarea id="storyboard-script-input" placeholder="ç²˜è´´ä½ çš„åˆ†é•œè„šæœ¬..." rows="6"></textarea>
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button id="btn-split-script" class="secondary mini">ğŸ” æ‹†åˆ†åˆ†é•œè„šæœ¬</button>
                <button id="btn-reset-split" class="secondary mini" style="display: none;">â†º é‡ç½®æ‹†åˆ†</button>
              </div>
            </div>
            <div id="split-result-area" style="display: none; margin-top: 8px; border: 1px solid var(--line); border-radius: 8px; padding: 10px; background: var(--bg-main);">
              <label style="font-weight:500; margin-bottom:5px; display:block;">æ‹†åˆ†ç»“æœï¼ˆå¯æ‰‹åŠ¨ç¼–è¾‘ï¼‰</label>
              <div id="split-list" style="max-height:200px; overflow-y:auto; display:flex; flex-direction:column; gap:6px;"></div>
            </div>

            <div class="form-group" style="margin-top: 8px;">
              <label>ç”ŸæˆèŒƒå›´</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <span>ä»</span>
                <input id="range-start" type="number" min="1" value="1" style="width: 80px;">
                <span>åˆ°</span>
                <input id="range-end" type="number" min="1" value="1" style="width: 80px;">
                <span>å·åˆ†é•œ</span>
              </div>
            </div>

            <div class="form-group"><label>3. è®¾å®šç”Ÿå›¾å‚æ•°</label>
              <input id="prompt-aspect-ratio" placeholder="ç”»å¹…æ¯”ä¾‹, ä¾‹å¦‚: 16:9, 9:16" value="16:9">
              <input id="prompt-style" placeholder="ç”»é¢é£æ ¼, ä¾‹å¦‚: å®«å´éªé£æ ¼, èµ›åšæœ‹å…‹" value="å®«å´éªé£æ ¼">
              <div class="toggle-buttons" id="grid-size-btns" style="margin-top: 8px;">
                <button data-value="2X2å››å®«æ ¼" class="active">2X2å››å®«æ ¼</button>
                <button data-value="3X3ä¹å®«æ ¼">3X3ä¹å®«æ ¼</button>
              </div>
            </div>
            <button id="btn-generate-prompts" style="margin-top: auto; padding: 14px;">ğŸ¨ ç”Ÿæˆåˆ†é•œå›¾æç¤ºè¯</button>
          </div>
        </div>
        <div class="output-panel">
          <div class="panel-header"><h2>ç”Ÿæˆçš„æç¤ºè¯</h2><div><button id="btn-copy-prompts" class="secondary mini">å¤åˆ¶</button><button id="btn-download-prompts" class="secondary mini">ä¸‹è½½ .txt</button></div></div>
          <div class="panel-body">
            <div id="output-area-prompter" class="output-area"></div>
            <div id="generation-info-prompter" class="generation-info" style="font-size:0.8rem; color:var(--text-muted); padding-top:8px; border-top:1px dashed var(--line); margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- æŒ‡ä»¤åº“æ¨¡æ€æ¡† -->
  <div id="prompt-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="panel-header"><h2>æŒ‡ä»¤æ¨¡æ¿åº“</h2><button id="btn-close-prompt-modal" class="secondary mini">&times;</button></div>
      <ul class="modal-list" id="prompt-list"></ul>
      <div style="padding: 20px; border-top: 1px solid var(--line); display: flex; flex-direction: column; gap: 10px;">
        <input id="new-prompt-name" placeholder="æ–°æŒ‡ä»¤åç§°"><textarea id="new-prompt-content" placeholder="æŒ‡ä»¤å†…å®¹" rows="3"></textarea>
        <button id="btn-save-prompt">ä¿å­˜ä¸ºæ–°æŒ‡ä»¤</button>
      </div>
    </div>
  </div>
  <!-- API åˆ‡æ¢æ¨¡æ€æ¡† -->
  <div id="api-switcher-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="panel-header"><h2>åˆ‡æ¢ API / æ¨¡å‹</h2><button id="btn-close-api-modal" class="secondary mini">&times;</button></div>
        <ul class="modal-list" id="api-list"></ul>
    </div>
  </div>

  <!-- å†å²è®°å½•æ¨¡æ€æ¡† -->
  <div id="history-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
      <div class="panel-header">
        <h2>å†å²ç”Ÿæˆè®°å½•</h2>
        <button id="btn-close-history-modal" class="secondary mini">&times;</button>
      </div>
      <ul class="modal-list" id="history-list" style="max-height: 60vh;"></ul>
    </div>
  </div>

  <script>
    const LS_KEY = "aicomic_workbench_v5_merged";
    const HISTORY_KEY = "aicomic_history_v1";
    let state = {};
    let splitShots = []; // å­˜å‚¨æ‹†åˆ†åçš„åˆ†é•œæ•°ç»„
    let currentGenInfo = {};

    document.addEventListener('DOMContentLoaded', () => {
        state = loadState();
        initializeUI();
        setupRouting();
        bindAllEvents();
        loadHistory();
    });

    function loadState() {
        const raw = localStorage.getItem(LS_KEY);
        const defaults = {
            configs: [], activeCfgId: null, darkMode: true, currentPage: 'storyboard-page',
            prompts: [
                { id: 'p1', name: 'æ ‡å‡†åˆ†é•œå¯¼æ¼”', content: 'ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„æ¼«å‰§å¯¼æ¼”ï¼Œæ“…é•¿ç”µå½±åŒ–å™äº‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„å‰§æœ¬è½¬æ¢æˆä¸€ä»½è¯¦ç»†ã€ä¸“ä¸šã€å¯æ‰§è¡Œçš„åˆ†é•œè„šæœ¬ã€‚è¯·ç¡®ä¿é•œå¤´è¯­è¨€ä¸°å¯Œï¼ŒèŠ‚å¥å¼ å¼›æœ‰åº¦ã€‚' },
                { id: 'p2', name: 'å¿«èŠ‚å¥çŸ­è§†é¢‘å¯¼æ¼”', content: 'ä½ æ˜¯ä¸€ä½é¡¶çº§çš„çŸ­è§†é¢‘å†…å®¹å¯¼æ¼”ï¼Œç²¾é€šç«–å±å™äº‹å’Œå¿«èŠ‚å¥å‰ªè¾‘ã€‚è¯·å°†ä»¥ä¸‹å‰§æœ¬æ”¹ç¼–æˆé€‚åˆçŸ­è§†é¢‘å¹³å°ä¼ æ’­çš„ç«–å±åˆ†é•œè„šæœ¬ï¼Œè¦æ±‚å‰3ç§’å¿…é¡»å¸å¼•äººï¼ŒèŠ‚å¥å¿«ï¼Œè½¬åœºå¤šã€‚' }
            ]
        };
        try { return raw ? { ...defaults, ...JSON.parse(raw) } : defaults; } 
        catch (e) { return defaults; }
    }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    let history = [];
    function loadHistory() {
        const raw = localStorage.getItem(HISTORY_KEY);
        try { history = raw ? JSON.parse(raw) : []; } catch { history = []; }
    }
    function saveHistory() {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }
    function addHistoryRecord(record) {
        history.unshift(record);
        if (history.length > 50) history.pop();
        saveHistory();
    }

    function getActiveCfg() { return state.configs.find(c => c.id === state.activeCfgId); }
    function uid() { return `id_${Date.now()}_${Math.random().toString(16).slice(2)}`; }

    function initializeUI() {
        if (state.darkMode) document.body.classList.add('dark-mode');
        updateDarkModeIcon();
    }

    function setupRouting() {
        const activeCfg = getActiveCfg();
        if (activeCfg && activeCfg.defaultModel) showMainApp();
        else showSetupPage();
        switchPage(state.currentPage);
    }
    function showSetupPage() {
        document.getElementById('setup-page').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
        renderSetupPage(); // æ¯æ¬¡æ˜¾ç¤ºé…ç½®é¡µé¢æ—¶é‡æ–°æ¸²æŸ“ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
    }
    function showMainApp() {
        document.getElementById('setup-page').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
    }
    function switchPage(pageId) {
        document.querySelectorAll('#main-app .page-content').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageId)?.classList.remove('hidden');
        document.querySelectorAll('#app-nav button').forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
        state.currentPage = pageId;
        saveState();
    }

    function bindAllEvents() {
        document.getElementById('btn-toggle-darkmode').addEventListener('click', toggleDarkMode);
        document.getElementById('app-nav').addEventListener('click', e => e.target.tagName === 'BUTTON' && switchPage(e.target.dataset.page));
        document.getElementById('btn-back-to-setup').addEventListener('click', showSetupPage);
        document.getElementById('btn-history').addEventListener('click', openHistoryModal);
        bindSetupEvents();
        bindStoryboardEvents();
        bindImagePromptEvents();
        bindPromptModalEvents();
        bindApiSwitcherModalEvents();
        bindHistoryModalEvents();
    }

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        state.darkMode = document.body.classList.contains('dark-mode');
        saveState();
        updateDarkModeIcon();
    }
    function updateDarkModeIcon() {
        const icon = document.getElementById('btn-toggle-darkmode');
        icon.innerHTML = state.darkMode 
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
    }

    // ---------- é…ç½®é¡µé¢äº‹ä»¶ ----------
    function bindSetupEvents() {
        const cfgSelect = document.getElementById('cfg-select');
        const cfgName = document.getElementById('cfg-name');
        const cfgBaseUrl = document.getElementById('cfg-baseurl');
        const cfgApiKey = document.getElementById('cfg-apikey');
        const cfgModel = document.getElementById('cfg-model');
        const statusArea = document.getElementById('status-area');

        cfgSelect.addEventListener('change', updateFormForSelectedCfg);

        document.getElementById('btn-save-cfg').addEventListener('click', () => {
            try {
                const id = cfgSelect.value || uid();
                const name = cfgName.value.trim();
                const baseUrl = cfgBaseUrl.value.trim();
                const apiKey = cfgApiKey.value.trim();
                if (!name || !baseUrl || !apiKey) {
                    statusArea.textContent = 'é”™è¯¯ï¼šåç§°ã€URLå’ŒKeyä¸èƒ½ä¸ºç©ºã€‚';
                    return;
                }
                let cfg = state.configs.find(c => c.id === id);
                if (cfg) {
                    if (cfg.baseUrl !== baseUrl || cfg.apiKey !== apiKey) {
                        cfg.modelsCache = [];
                        cfg.defaultModel = null;
                    }
                    Object.assign(cfg, { name, baseUrl, apiKey });
                } else {
                    cfg = { id, name, baseUrl, apiKey, modelsCache: [], defaultModel: null };
                    state.configs.push(cfg);
                }
                state.activeCfgId = id;
                saveState();
                renderSetupPage(); // é‡æ–°æ¸²æŸ“ä¸‹æ‹‰æ¡†
                statusArea.textContent = `é…ç½® "${name}" å·²ä¿å­˜ã€‚`;
            } catch (e) {
                statusArea.textContent = `ä¿å­˜å¤±è´¥: ${e.message}`;
            }
        });

        document.getElementById('btn-fetch-models').addEventListener('click', async () => {
            try {
                const cfgData = {
                    baseUrl: cfgBaseUrl.value.trim(),
                    apiKey: cfgApiKey.value.trim()
                };
                if (!cfgData.baseUrl || !cfgData.apiKey) {
                    statusArea.textContent = 'è¯·å…ˆå¡«å†™ Base URL å’Œ API Keyã€‚';
                    return;
                }
                statusArea.textContent = 'æ­£åœ¨åŠ è½½æ¨¡å‹...';
                const { ids } = await fetchModels(cfgData);
                const selectedCfgId = cfgSelect.value;
                const cfg = selectedCfgId ? state.configs.find(c => c.id === selectedCfgId) : null;
                if (cfg) {
                    cfg.modelsCache = ids;
                    cfg.defaultModel = cfg.defaultModel || ids[0] || null;
                }
                renderModelSelect(ids, (cfg ? cfg.defaultModel : null) || ids[0]);
                statusArea.textContent = `æˆåŠŸåŠ è½½ ${ids.length} ä¸ªæ¨¡å‹ã€‚è¯·ä¿å­˜é…ç½®ä»¥åº”ç”¨æ›´æ”¹ã€‚`;
            } catch (e) {
                statusArea.textContent = `åŠ è½½å¤±è´¥: ${e.message}`;
            }
        });

        cfgModel.addEventListener('change', () => {
            const activeCfg = state.configs.find(c => c.id === cfgSelect.value);
            if (activeCfg) {
                activeCfg.defaultModel = cfgModel.value;
                updateContinueButton();
            }
        });

        document.getElementById('btn-continue').addEventListener('click', showMainApp);
    }

    function renderSetupPage() {
        const cfgSelect = document.getElementById('cfg-select');
        cfgSelect.innerHTML = '<option value="">--- æ–°å»ºé…ç½® ---</option>';
        state.configs.forEach(cfg => {
            const opt = document.createElement('option');
            opt.value = cfg.id;
            opt.textContent = cfg.name;
            if (cfg.id === state.activeCfgId) opt.selected = true;
            cfgSelect.appendChild(opt);
        });
        updateFormForSelectedCfg();
    }

    function updateFormForSelectedCfg() {
        const cfg = state.configs.find(c => c.id === document.getElementById('cfg-select').value);
        document.getElementById('cfg-name').value = cfg ? cfg.name : '';
        document.getElementById('cfg-baseurl').value = cfg ? cfg.baseUrl : '';
        document.getElementById('cfg-apikey').value = cfg ? cfg.apiKey : '';
        renderModelSelect(cfg ? cfg.modelsCache || [] : [], cfg ? cfg.defaultModel : null);
        updateContinueButton();
    }

    function renderModelSelect(models, defaultModel) {
        const cfgModel = document.getElementById('cfg-model');
        cfgModel.innerHTML = models.length > 0 ? '' : '<option>è¯·å…ˆåŠ è½½æ¨¡å‹</option>';
        models.forEach(modelId => {
            const opt = document.createElement('option');
            opt.value = modelId;
            opt.textContent = modelId;
            if (modelId === defaultModel) opt.selected = true;
            cfgModel.appendChild(opt);
        });
    }

    function updateContinueButton() {
        const btnContinue = document.getElementById('btn-continue');
        const cfg = state.configs.find(c => c.id === document.getElementById('cfg-select').value);
        const hasModel = document.getElementById('cfg-model').value;
        if (cfg && hasModel) {
            btnContinue.disabled = false;
            btnContinue.textContent = `è¿›å…¥å·¥ä½œå° (ä½¿ç”¨: ${cfg.name})`;
            state.activeCfgId = cfg.id;
            cfg.defaultModel = hasModel;
            saveState();
        } else {
            btnContinue.disabled = true;
            btnContinue.textContent = 'è¯·é…ç½®APIå¹¶é€‰æ‹©æ¨¡å‹';
        }
    }

    // ---------- åˆ†é•œè„šæœ¬ç”Ÿæˆé¡µäº‹ä»¶ ----------
    function bindStoryboardEvents() {
        const generateBtn = document.getElementById('btn-generate-storyboard');
        const outputArea = document.getElementById('output-area-storyboard');

        const styleBtns = document.getElementById('style-btns');
        const customStyleInput = document.getElementById('custom-style-input');
        styleBtns.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                styleBtns.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                if (e.target.dataset.value === 'è‡ªå®šä¹‰') {
                    customStyleInput.style.display = 'block';
                } else {
                    customStyleInput.style.display = 'none';
                }
            }
        });

        const shotCountInput = document.getElementById('shot-count');
        const shotCountAutoBtn = document.getElementById('shot-count-auto');
        shotCountAutoBtn.addEventListener('click', () => {
            shotCountInput.disabled = !shotCountInput.disabled;
            if (shotCountInput.disabled) {
                shotCountInput.value = '';
                shotCountAutoBtn.classList.add('active');
            } else {
                shotCountAutoBtn.classList.remove('active');
            }
        });
        shotCountInput.addEventListener('focus', () => {
            shotCountInput.disabled = false;
            shotCountAutoBtn.classList.remove('active');
        });
        shotCountInput.addEventListener('blur', () => {
            if (!shotCountInput.value) {
                shotCountAutoBtn.classList.add('active');
                shotCountInput.disabled = true;
            }
        });

        generateBtn.addEventListener('click', async () => {
            const activeCfg = getActiveCfg();
            if (!activeCfg) { alert('APIé…ç½®ä¸¢å¤±ï¼Œè¯·è¿”å›é…ç½®é¡µé¢ã€‚'); return showSetupPage(); }
            const script = document.getElementById('script-input').value.trim();
            const instruction = document.getElementById('instruction-input').value.trim();
            if(!script || !instruction) return alert('å‰§æœ¬å’Œæ ¸å¿ƒæŒ‡ä»¤ä¸èƒ½ä¸ºç©ºã€‚');

            const aspectRatio = document.querySelector('#aspect-ratio-btns .active').dataset.value;
            let style = document.querySelector('#style-btns .active').dataset.value;
            if (style === 'è‡ªå®šä¹‰') {
                style = customStyleInput.value.trim() || 'è‡ªå®šä¹‰';
            }
            const durationActive = document.querySelector('#duration-btns .active')?.dataset.value;
            const duration = durationActive ? durationActive : (document.getElementById('custom-duration-input').value || 'æœªçŸ¥') + 'ç§’';
            let shotCount = 'ç”±AIè‡ªåŠ¨é€‚é…';
            if (!shotCountInput.disabled && shotCountInput.value) {
                shotCount = shotCountInput.value;
            }

            const userPrompt = `
### ä»»åŠ¡è¦æ±‚
${instruction}

### å‰§æœ¬åŸæ–‡
${script}

### åˆ†é•œå‚æ•°
- **ç”»å¹…:** ${aspectRatio}
- **é£æ ¼:** ${style}
- **æˆç‰‡é¢„ä¼°æ—¶é•¿:** ${duration}
- **åˆ†é•œæ•°:** ${shotCount}

### è¾“å‡ºæ ¼å¼è¦æ±‚
è¯·ä½¿ç”¨Markdownæ ¼å¼è¾“å‡ºã€‚æ¯ä¸ªåˆ†é•œéƒ½å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§æ­¤ç»“æ„ï¼š

## é•œå¤´ 01
- **å‡ºåœºäººç‰©:** [æ ¹æ®åŸå‰§æœ¬è§£æå‡ºåœºäººç‰©ï¼Œå¹¶å…¨éƒ¨ç½—åˆ—å‡ºæ¥ï¼Œä¾‹å¦‚ï¼šèƒ¡å›¾å›¾ã€å¼ å°ä¸½]
- **ä¸»è¦åœºæ™¯:** [æ ¹æ®åŸå‰§æœ¬è§£æä¸»è¦åœºæ™¯ï¼Œå¹¶å…¨éƒ¨ç½—åˆ—å‡ºæ¥ï¼Œä¾‹å¦‚ï¼šå°åŒºå…¬å›­]
- **æ™¯åˆ«:** [ä¾‹å¦‚: å…¨æ™¯, ä¸­æ™¯, ç‰¹å†™ï¼Œè¯¦ç»†å‚è€ƒæ ¸å¿ƒæŒ‡ä»¤]
- **é•œå¤´ä¸è¿é•œ:** [ä¾‹å¦‚: å›ºå®šé•œå¤´, ä»å·¦å‘å³æ¨é•œï¼Œè¯¦ç»†å‚è€ƒæ ¸å¿ƒæŒ‡ä»¤]
- **éŸ³æ•ˆ:** [ç¯å¢ƒéŸ³ã€ç‰¹æ®Šæ•ˆæœéŸ³ï¼Œå¦‚æ— åˆ™å¡«å†™"æ— "]
- **æ—¶é•¿:** [é¢„ä¼°æ­¤é•œå¤´çš„ç§’æ•°ï¼Œä¾‹å¦‚: 2s]
- **ç”»é¢æè¿°:** [ç”¨ç®€å•ç›´ç™½å®¢è§‚çš„è¯­è¨€è¿›è¡Œæè¿°ï¼Œä¸¥æ ¼æŒ‰ç…§æ ¸å¿ƒæŒ‡ä»¤è¾“å‡ºï¼Œç»“æ„é‡‡ç”¨æ™¯åˆ«+é•œå¤´è¿é•œ+æè¿°ç”»é¢å†…å®¹ã€äººç‰©åŠ¨ä½œå’Œè¡¨æƒ…+å¯¹ç™½ï¼ˆæ— åˆ™ä¸å†™ï¼‰+ç¯å¢ƒç»†èŠ‚]
`;

            outputArea.textContent = 'æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...';
            document.getElementById('generation-info-storyboard').textContent = '';
            generateBtn.disabled = true;
            const startTime = Date.now();
            try {
                const result = await callLLM(activeCfg, [{role: 'user', content: userPrompt}]);
                const durationSec = ((Date.now() - startTime) / 1000).toFixed(2);
                outputArea.textContent = result.content;
                document.getElementById('generation-info-storyboard').textContent = `æ¨¡å‹: ${activeCfg.defaultModel} | è€—æ—¶: ${durationSec}s | Tokens: ${result.usage?.total_tokens || 'æœªçŸ¥'}`;
            } catch(e) { outputArea.textContent = `ç”Ÿæˆå¤±è´¥ï¼š\n\n${e.message}`; } finally { generateBtn.disabled = false; }
        });

        document.getElementById('btn-copy-storyboard').addEventListener('click', () => navigator.clipboard.writeText(outputArea.textContent));
        document.getElementById('btn-download-storyboard').addEventListener('click', () => downloadFile('åˆ†é•œè„šæœ¬.txt', outputArea.textContent));
        setupDragDrop('drop-zone-storyboard', 'script-input');
        document.querySelectorAll('.toggle-buttons').forEach(g => {
            if (g.id === 'style-btns') return;
            g.addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') {
                    g.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                }
            });
        });
    }

    // ---------- åˆ†é•œå›¾æç¤ºè¯é¡µ ----------
    function bindImagePromptEvents() {
        const generateBtn = document.getElementById('btn-generate-prompts');
        const originalScriptInput = document.getElementById('original-script-input');
        const storyboardScriptInput = document.getElementById('storyboard-script-input');
        const aspectRatioInput = document.getElementById('prompt-aspect-ratio');
        const styleInput = document.getElementById('prompt-style');
        const gridSizeBtns = document.getElementById('grid-size-btns');
        const outputArea = document.getElementById('output-area-prompter');
        const genInfoDiv = document.getElementById('generation-info-prompter');
        const splitBtn = document.getElementById('btn-split-script');
        const resetSplitBtn = document.getElementById('btn-reset-split');
        const splitResultArea = document.getElementById('split-result-area');
        const splitListDiv = document.getElementById('split-list');
        const rangeStart = document.getElementById('range-start');
        const rangeEnd = document.getElementById('range-end');

        function extractJSON(text) {
            const startIdx = text.search(/[{\[]/);
            if (startIdx === -1) return null;
            const stack = [];
            let inString = false, escape = false, endIdx = -1;
            for (let i = startIdx; i < text.length; i++) {
                const char = text[i];
                if (!inString) {
                    if (char === '"') inString = true;
                    else if (char === '{' || char === '[') stack.push(char);
                    else if (char === '}' || char === ']') {
                        if (stack.length === 0) break;
                        const last = stack.pop();
                        if ((char === '}' && last !== '{') || (char === ']' && last !== '[')) return null;
                        if (stack.length === 0) { endIdx = i + 1; break; }
                    }
                } else {
                    if (escape) escape = false;
                    else if (char === '\\') escape = true;
                    else if (char === '"') inString = false;
                }
            }
            if (endIdx === -1) return null;
            const jsonStr = text.substring(startIdx, endIdx);
            try { return JSON.parse(jsonStr); } 
            catch (e) {
                let cleaned = jsonStr.replace(/'/g, '"').replace(/,\s*([}\]])/g, '$1')
                                     .replace(/\/\/.*?(\n|$)/g, '').replace(/\/\*[\s\S]*?\*\//g, '');
                try { return JSON.parse(cleaned); } catch { return null; }
            }
        }

        splitBtn.addEventListener('click', async () => {
            const script = storyboardScriptInput.value.trim();
            if (!script) return alert('è¯·å…ˆè¾“å…¥åˆ†é•œè„šæœ¬ã€‚');
            const activeCfg = getActiveCfg();
            if (!activeCfg) { alert('APIé…ç½®ä¸¢å¤±ï¼Œè¯·è¿”å›é…ç½®é¡µé¢ã€‚'); return showSetupPage(); }

            const prompt = `ä½ æ˜¯ä¸€ä¸ªåˆ†é•œè„šæœ¬æ‹†åˆ†åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹åˆ†é•œè„šæœ¬æ‹†åˆ†æˆç‹¬ç«‹çš„åˆ†é•œï¼Œæ¯ä¸ªåˆ†é•œä»¥â€œ## é•œå¤´ XXâ€æˆ–ç±»ä¼¼æ ‡é¢˜å¼€å¤´ã€‚è¯·è¿”å›ä¸€ä¸ª JSON æ•°ç»„ï¼Œæ•°ç»„æ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªåˆ†é•œçš„å®Œæ•´æ–‡æœ¬ï¼ˆåŒ…æ‹¬æ ‡é¢˜å’Œå†…å®¹ï¼‰ã€‚ä¸è¦åŒ…å«ä»»ä½•é¢å¤–è§£é‡Šï¼Œä»…è¿”å› JSON æ•°ç»„ã€‚

è„šæœ¬å†…å®¹ï¼š
${script}`;

            splitBtn.textContent = 'æ‹†åˆ†ä¸­...';
            splitBtn.disabled = true;
            try {
                const result = await callLLM(activeCfg, [{role: 'user', content: prompt}]);
                const parsed = extractJSON(result.content);
                if (!parsed) throw new Error("AIæœªè¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼ã€‚");
                const shots = Array.isArray(parsed) ? parsed : (parsed.shots || []);
                if (shots.length === 0) throw new Error("æœªæå–åˆ°ä»»ä½•åˆ†é•œã€‚");
                splitShots = shots;
                renderSplitList(shots);
                splitResultArea.style.display = 'block';
                resetSplitBtn.style.display = 'inline-block';
                rangeEnd.max = shots.length;
                rangeEnd.value = shots.length;
                rangeStart.max = shots.length;
                rangeStart.value = 1;
            } catch (e) {
                alert(`æ‹†åˆ†å¤±è´¥: ${e.message}`);
                console.error(e);
            } finally {
                splitBtn.textContent = 'ğŸ” æ‹†åˆ†åˆ†é•œè„šæœ¬';
                splitBtn.disabled = false;
            }
        });

        resetSplitBtn.addEventListener('click', () => {
            splitShots = [];
            splitResultArea.style.display = 'none';
            splitListDiv.innerHTML = '';
            resetSplitBtn.style.display = 'none';
            rangeStart.value = 1;
            rangeEnd.value = 1;
        });

        function renderSplitList(shots) {
            splitListDiv.innerHTML = '';
            shots.forEach((shotText, idx) => {
                const shotDiv = document.createElement('div');
                shotDiv.style.display = 'flex';
                shotDiv.style.gap = '8px';
                shotDiv.style.alignItems = 'flex-start';
                shotDiv.innerHTML = `
                    <span style="min-width: 60px; font-weight:500;">é•œå¤´ ${idx+1}</span>
                    <textarea rows="2" style="flex-grow:1; font-size:0.85rem;" data-index="${idx}">${shotText.replace(/"/g, '&quot;')}</textarea>
                `;
                const textarea = shotDiv.querySelector('textarea');
                textarea.addEventListener('input', (e) => {
                    splitShots[e.target.dataset.index] = e.target.value;
                });
                splitListDiv.appendChild(shotDiv);
            });
        }

        generateBtn.addEventListener('click', async () => {
            const originalScript = originalScriptInput.value.trim();
            const aspectRatio = aspectRatioInput.value.trim();
            const style = styleInput.value.trim();
            const gridSize = document.querySelector('#grid-size-btns .active').dataset.value;
            const gridCount = gridSize === '2X2å››å®«æ ¼' ? 4 : 9;

            if (!originalScript || !aspectRatio || !style) {
                return alert('è¯·å¡«å†™åŸå‰§æœ¬ã€ç”»å¹…æ¯”ä¾‹å’Œé£æ ¼ã€‚');
            }
            if (splitShots.length === 0) {
                return alert('è¯·å…ˆç‚¹å‡»â€œæ‹†åˆ†åˆ†é•œè„šæœ¬â€æŒ‰é’®ï¼Œæ‹†åˆ†åå†é€‰æ‹©èŒƒå›´ç”Ÿæˆã€‚');
            }

            const start = parseInt(rangeStart.value) || 1;
            const end = parseInt(rangeEnd.value) || splitShots.length;
            if (start < 1 || end > splitShots.length || start > end) {
                alert(`ç”ŸæˆèŒƒå›´é”™è¯¯ï¼Œè¯·é‡æ–°å¡«å†™ï¼ï¼ˆæœ‰æ•ˆèŒƒå›´ 1-${splitShots.length}ï¼‰`);
                return;
            }

            const selectedShots = splitShots.slice(start-1, end).map((shot, idx) => `é•œå¤´ ${start+idx}ï¼š\n${shot}`).join('\n\n');

            const prompt = `ç°åœ¨ä½ æ˜¯è‘—åçš„åˆ†é•œå›¾AIæç¤ºè¯å¤§å¸ˆã€‚è¯·æ ¹æ®æä¾›çš„åŸå‰§æœ¬å’Œåˆ†é•œè„šæœ¬ï¼Œä¸ºä»¥ä¸‹æŒ‡å®šçš„åˆ†é•œï¼ˆä»é•œå¤´${start}åˆ°é•œå¤´${end}ï¼‰ç”Ÿæˆå¯¹åº”çš„ ${gridSize} åˆ†é•œå¤´ç»„çš„æç¤ºè¯ã€‚æ¯ä¸ªåˆ†é•œçš„æç¤ºè¯å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š

åˆ†é•œXï¼š
ã€å‰ç½®å¿…é¡»ã€‘ç”Ÿæˆä¸€ç»„ ${gridSize} åˆ†é•œå¤´ç»„ï¼Œç¡®ä¿æ¯ä¸ªé•œå¤´éƒ½ä¿æŒ ${aspectRatio} çš„ç”»å¹…æ¯”ä¾‹ï¼Œä¸è¦å‡ºç°å¯¹è¯æ¡†å’Œæ–‡å­—ï¼Œä¸è¦å‡ºç°å­—å¹•ï¼Œä¸è¦æ˜¾ç¤ºé•œå¤´å·ï¼Œä¸è¦æ˜¾ç¤ºæ–‡å­—å¤‡æ³¨ï¼Œä¸è¦æ°”æ³¡æ¡†ï¼Œä»…è¾“å‡ºç»“æœã€‚
${style} é£æ ¼ï¼Œæ¶µç›–ä¸åŒæ™¯åˆ«ä»¥åŠè§’åº¦ï¼Œç”»é¢ç²¾ç»†ã€‚
1. [ç¬¬ä¸€ä¸ªé•œå¤´çš„æè¿°]
2. [ç¬¬äºŒä¸ªé•œå¤´çš„æè¿°]
3. [ç¬¬ä¸‰ä¸ªé•œå¤´çš„æè¿°]
4. [ç¬¬å››ä¸ªé•œå¤´çš„æè¿°]
${gridCount === 9 ? '5. [ç¬¬äº”ä¸ªé•œå¤´çš„æè¿°]\n6. [ç¬¬å…­ä¸ªé•œå¤´çš„æè¿°]\n7. [ç¬¬ä¸ƒä¸ªé•œå¤´çš„æè¿°]\n8. [ç¬¬å…«ä¸ªé•œå¤´çš„æè¿°]\n9. [ç¬¬ä¹ä¸ªé•œå¤´çš„æè¿°]' : ''}

ï¼ˆæ¯ä¸ªåˆ†é•œçš„æç¤ºè¯ç»„ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”ï¼Œæœ€ç»ˆè¾“å‡ºæŒ‡å®šèŒƒå›´å†…æ‰€æœ‰åˆ†é•œçš„æç¤ºè¯ã€‚ï¼‰

è¯·æ ¹æ®åŸå‰§æœ¬çš„å‰§æƒ…å’Œåˆ†é•œè„šæœ¬ä¸­çš„é•œå¤´æè¿°ï¼Œä¸ºæ¯ä¸ªåˆ†é•œè®¾è®¡ ${gridCount} ä¸ªè¿è´¯çš„é•œå¤´ç”»é¢ï¼Œæè¿°è¦ç®€çŸ­ã€ç²¾ç‚¼ã€å……æ»¡è§†è§‰å†²å‡»åŠ›ï¼Œä½¿ç”¨ä¸­æ–‡ã€‚

è¾“å…¥ä¿¡æ¯ï¼š
ç”»å¹…æ¯”ä¾‹: ${aspectRatio}
é£æ ¼: ${style}

### åŸå‰§æœ¬
${originalScript}

### éœ€è¦ç”Ÿæˆçš„åˆ†é•œï¼ˆä»é•œå¤´${start}åˆ°é•œå¤´${end}ï¼‰
${selectedShots}

è¯·å¼€å§‹ç”Ÿæˆï¼Œä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡ºã€‚`;

            outputArea.textContent = 'æ­£åœ¨ç”Ÿæˆæç¤ºè¯...';
            genInfoDiv.textContent = '';
            generateBtn.disabled = true;
            const startTime = Date.now();
            try {
                const result = await callLLM(getActiveCfg(), [{role: 'user', content: prompt}]);
                const durationSec = ((Date.now() - startTime) / 1000).toFixed(2);
                outputArea.textContent = result.content;
                const modelName = getActiveCfg().defaultModel;
                const tokenInfo = result.usage?.total_tokens || 'æœªçŸ¥';
                genInfoDiv.textContent = `æ¨¡å‹: ${modelName} | è€—æ—¶: ${durationSec}s | Tokens: ${tokenInfo}`;

                addHistoryRecord({
                    timestamp: new Date().toLocaleString(),
                    originalScript,
                    storyboardScript: storyboardScriptInput.value.trim(),
                    aspectRatio, style, gridSize,
                    range: `${start}-${end}`,
                    output: result.content,
                    model: modelName,
                    duration: durationSec,
                    tokens: tokenInfo
                });
            } catch (e) {
                outputArea.textContent = `ç”Ÿæˆå¤±è´¥ï¼š\n${e.message}`;
            } finally {
                generateBtn.disabled = false;
            }
        });

        document.getElementById('btn-copy-prompts').addEventListener('click', () => {
            navigator.clipboard.writeText(outputArea.textContent);
        });
        document.getElementById('btn-download-prompts').addEventListener('click', () => {
            downloadFile('åˆ†é•œå›¾æç¤ºè¯.txt', outputArea.textContent);
        });
        setupDragDrop('drop-zone-original', 'original-script-input');
        setupDragDrop('drop-zone-storyboard-script', 'storyboard-script-input');
        gridSizeBtns.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                gridSizeBtns.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });
    }

    // ---------- å†å²è®°å½•æ¨¡æ€æ¡† ----------
    function openHistoryModal() {
        renderHistoryList();
        document.getElementById('history-modal').style.display = 'flex';
    }

    function bindHistoryModalEvents() {
        const modal = document.getElementById('history-modal');
        const closeBtn = document.getElementById('btn-close-history-modal');
        closeBtn.addEventListener('click', () => modal.style.display = 'none');
        modal.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });
    }

    function renderHistoryList() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        if (history.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-muted);">æš‚æ— å†å²è®°å½•</div>';
            return;
        }
        history.forEach((rec, idx) => {
            const item = document.createElement('li'); item.className = 'modal-item';
            item.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:4px; flex-grow:1;">
                    <span class="name">${rec.timestamp} | ${rec.range} | ${rec.model}</span>
                    <span class="details" style="font-size:0.8rem;">é£æ ¼: ${rec.style} | ç”»å¹…: ${rec.aspectRatio}</span>
                </div>
                <div>
                    <button class="secondary mini btn-view-history" data-index="${idx}">æŸ¥çœ‹</button>
                    <button class="secondary mini btn-copy-history" data-index="${idx}">å¤åˆ¶</button>
                    <button class="secondary mini btn-download-history" data-index="${idx}">ä¸‹è½½</button>
                </div>
            `;
            list.appendChild(item);
        });

        list.querySelectorAll('.btn-view-history').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = e.target.dataset.index;
                const rec = history[idx];
                alert('é¢„è§ˆï¼ˆå‰200å­—ç¬¦ï¼‰ï¼š\n\n' + rec.output.substring(0,200) + '...');
            });
        });
        list.querySelectorAll('.btn-copy-history').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = e.target.dataset.index;
                navigator.clipboard.writeText(history[idx].output);
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        });
        list.querySelectorAll('.btn-download-history').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const idx = e.target.dataset.index;
                const rec = history[idx];
                downloadFile(`åˆ†é•œå›¾æç¤ºè¯_${rec.timestamp}.txt`, rec.output);
            });
        });
    }

    // ---------- API åˆ‡æ¢æ¨¡æ€æ¡† ----------
    function bindApiSwitcherModalEvents() {
        const modal = document.getElementById('api-switcher-modal');
        const list = document.getElementById('api-list');
        const open = () => {
            renderApiList();
            modal.style.display = 'flex';
        };
        const close = () => modal.style.display = 'none';
        document.getElementById('btn-switch-api').addEventListener('click', open);
        document.getElementById('btn-close-api-modal').addEventListener('click', close);
        modal.addEventListener('click', e => { if (e.target === modal) close(); });

        function renderApiList() {
            list.innerHTML = '';
            if (state.configs.length === 0) {
                list.innerHTML = '<li style="padding:20px; text-align:center;">æš‚æ— å·²ä¿å­˜çš„é…ç½®</li>';
                return;
            }
            state.configs.forEach(cfg => {
                const item = document.createElement('li'); item.className = 'modal-item';
                item.innerHTML = `<div style="display:flex; flex-direction:column; gap:4px;"><span class="name">${cfg.name}</span><span class="details">${cfg.defaultModel || 'æœªè®¾ç½®æ¨¡å‹'}</span></div>`;
                if (cfg.id === state.activeCfgId) item.style.background = 'var(--brand-light)';
                item.addEventListener('click', () => {
                    state.activeCfgId = cfg.id;
                    saveState();
                    close();
                    alert(`å·²åˆ‡æ¢åˆ° API: ${cfg.name}`);
                    // å¯é€‰ï¼šæ›´æ–°ä¸»ç•Œé¢çŠ¶æ€
                });
                list.appendChild(item);
            });
        }
    }

    // ---------- æŒ‡ä»¤æ¨¡æ¿åº“ ----------
    function bindPromptModalEvents() {
        const modal = document.getElementById('prompt-modal');
        const list = document.getElementById('prompt-list');
        const open = () => { modal.style.display = 'flex'; renderList(); };
        const close = () => modal.style.display = 'none';
        document.getElementById('btn-manage-prompts').addEventListener('click', open);
        document.getElementById('btn-close-prompt-modal').addEventListener('click', close);
        modal.addEventListener('click', e => { if (e.target === modal) close(); });

        function renderList() {
            list.innerHTML = '';
            state.prompts.forEach(p => {
                const item = document.createElement('li'); item.className = 'modal-item';
                item.innerHTML = `<span class="name">${p.name}</span><div><button class="secondary mini btn-use" data-id="${p.id}">ä½¿ç”¨</button><button class="mini btn-delete" style="background:#fee2e2;color:#b91c1c;margin-left:8px;" data-id="${p.id}">åˆ é™¤</button></div>`;
                list.appendChild(item);
            });
        }
        list.addEventListener('click', e => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('btn-use')) {
                const prompt = state.prompts.find(p => p.id === id);
                if (prompt) document.getElementById('instruction-input').value = prompt.content;
                close();
            } else if (e.target.classList.contains('btn-delete')) {
                state.prompts = state.prompts.filter(p => p.id !== id);
                saveState();
                renderList();
            }
        });
        document.getElementById('btn-save-prompt').addEventListener('click', () => {
            const name = document.getElementById('new-prompt-name').value.trim();
            const content = document.getElementById('new-prompt-content').value.trim();
            if (!name || !content) return;
            state.prompts.push({ id: uid(), name, content });
            saveState();
            renderList();
            document.getElementById('new-prompt-name').value = '';
            document.getElementById('new-prompt-content').value = '';
        });
    }

    // ---------- å·¥å…·å‡½æ•° ----------
    function downloadFile(filename, text) {
        const el = document.createElement('a');
        el.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
        el.setAttribute('download', filename);
        el.style.display = 'none';
        document.body.appendChild(el);
        el.click();
        document.body.removeChild(el);
    }

    function setupDragDrop(zoneId, inputId) {
        const z = document.getElementById(zoneId);
        const i = document.getElementById(inputId);
        z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('dragover'); });
        z.addEventListener('dragleave', () => z.classList.remove('dragover'));
        z.addEventListener('drop', e => {
            e.preventDefault();
            z.classList.remove('dragover');
            if (e.dataTransfer.files[0]) {
                const reader = new FileReader();
                reader.onload = e => i.value = e.target.result;
                reader.readAsText(e.dataTransfer.files[0]);
            }
        });
    }

    async function fetchModels(cfg) {
        const url = `${(cfg.baseUrl || "").trim().replace(/\/+$/, "")}/models`;
        const headers = { "Authorization": "Bearer " + (cfg.apiKey || "") };
        const resp = await fetch(url, { method: "GET", headers });
        const text = await resp.text();
        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${text.slice(0, 200)}`);
        const data = JSON.parse(text);
        const ids = (Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : [])).map(x => x?.id).filter(Boolean);
        if (ids.length === 0) throw new Error("æ¨¡å‹åˆ—è¡¨ä¸ºç©º");
        return { ids: Array.from(new Set(ids)).sort() };
    }

    async function callLLM(cfg, messages) {
        const url = `${cfg.baseUrl}/chat/completions`;
        const headers = { "Content-Type": "application/json", "Authorization": "Bearer " + cfg.apiKey };
        const body = JSON.stringify({ model: cfg.defaultModel, messages, temperature: 0.7 });
        const resp = await fetch(url, { method: "POST", headers, body });
        const text = await resp.text();
        if (!resp.ok) throw new Error(`APIé”™è¯¯ ${resp.status}: ${text.slice(0, 500)}`);
        const data = JSON.parse(text);
        const content = data?.choices?.[0]?.message?.content;
        if (typeof content !== 'string') throw new Error("APIè¿”å›æ ¼å¼ä¸æ­£ç¡®ã€‚");
        return { content, usage: data.usage };
    }
  </script>
</body>
</html>